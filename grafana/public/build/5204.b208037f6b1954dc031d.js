"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5204],{"./public/app/features/dashboard/state/initDashboard.ts":(e,a,r)=>{r.d(a,{ZQ:()=>w,mV:()=>y,f1:()=>j,$M:()=>k});var t=r("./packages/grafana-data/src/index.ts"),s=r("./packages/grafana-runtime/src/index.ts"),o=r("./public/app/core/actions/index.ts"),n=r("./public/app/core/copy/appNotification.ts"),i=r("./public/app/core/services/backend_srv.ts"),d=r("./public/app/core/services/keybindingSrv.ts"),c=r("./public/app/core/store.ts"),l=r("./public/app/features/dashboard/services/DashboardLoaderSrv.ts"),u=r("./public/app/features/dashboard/services/DashboardSrv.ts"),p=r("./public/app/features/dashboard/services/TimeSrv.ts"),h=r("./public/app/features/live/dashboard/dashboardWatcher.ts"),b=r("./public/app/features/variables/utils.ts"),f=r("./public/app/types/index.ts"),g=r("./public/app/features/query/state/DashboardQueryRunner/DashboardQueryRunner.ts"),v=r("./public/app/features/variables/state/actions.ts"),m=r("./public/app/features/variables/state/selectors.ts"),x=r("./public/app/features/dashboard/state/DashboardModel.ts");var S=r("./public/app/features/dashboard/state/reducers.ts");function y(e){return async(a,r)=>{var y;a((0,S.sf)());const k=await async function(e,a,r){const o=c.Z.getObject(D);if(o)return j(),o;try{switch(e.routeName){case f.vq.Home:{const e=await i.ae.get("/api/dashboards/home");if(e.redirectUri){const a=t.locationUtil.stripBaseFromUrl(e.redirectUri);return s.locationService.replace(a),null}return e.meta.canSave=!1,e.meta.canShare=!1,e.meta.canStar=!1,e}case f.vq.Normal:{const a=await l.pD.loadDashboard(e.urlType,e.urlSlug,e.urlUid);if(e.fixUrl&&a.meta.url){const e=t.locationUtil.stripBaseFromUrl(a.meta.url),r=s.locationService.getLocation().pathname;e!==r&&(s.locationService.replace(Object.assign({},s.locationService.getLocation(),{pathname:e})),console.log("not correct url correcting",e,r))}return a}case f.vq.New:return w(e.urlFolderId);default:throw{message:"Unknown route "+e.routeName}}}catch(e){return e.cancelled||(a((0,S.jA)({message:"Failed to fetch dashboard",error:e})),console.error(e)),null}}(e,a);if(!k)return;let _;a((0,S.Nv)());try{_=new x.f(k.dashboard,k.meta)}catch(e){return a((0,S.jA)({message:"Failed create dashboard model",error:e})),void console.error(e)}const N=r(),A=s.locationService.getSearchObject();A.orgId||s.locationService.partial({orgId:N.user.orgId},!0);const T=(0,p.$t)();(0,u.h4)().setCurrent(_),T.init(_);const U=(0,b.mn)(null!==(y=e.urlUid)&&void 0!==y?y:_.uid);await a((0,v.LX)(U,_));if((0,g.Tl)({dashboard:_,timeSrv:T}).run({dashboard:_,range:T.timeRange()}),(0,m.cp)(r())===U&&r().dashboard.initPhase===f.bG.Services){try{_.processRepeats(),A.autofitpanels&&_.autoFitPanels(window.innerHeight,A.kiosk),d.K.setupDashboardBindings(_)}catch(e){a((0,o.$l)((0,n.t_)("Dashboard init failed",e))),console.error(e)}e.routeName!==f.vq.New?(!function(e){const a={dashboardId:e.id,dashboardName:e.title,dashboardUid:e.uid,folderName:e.meta.folderTitle,eventName:s.MetaAnalyticsEventName.DashboardView};(0,s.reportMetaAnalytics)(a)}(_),h.H.watch(_.uid)):h.H.leave(),""!==_.weekStart?(0,t.setWeekStart)(_.weekStart):(0,t.setWeekStart)(s.config.bootData.user.weekStart),a((0,S.dS)(_))}}}function w(e){const a={meta:{canStar:!1,canShare:!1,isNew:!0,folderId:0},dashboard:{title:"New dashboard",panels:[{type:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"Panel Title"}]}};return e&&(a.meta.folderId=parseInt(e,10)),a}const D="DASHBOARD_FROM_LS_KEY";function k(e){c.Z.setObject(D,e)}function j(){c.Z.delete(D)}},"./public/app/features/explore/AddToDashboard/index.tsx":(e,a,r)=>{r.r(a),r.d(a,{AddToDashboard:()=>_});var t=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),s=r("./.yarn/__virtual__/react-redux-virtual-7ad20a440e/3/opt/drone/yarncache/react-redux-npm-7.2.6-134f5ed64d-0bf142ce0d.zip/node_modules/react-redux/es/index.js"),o=r("./packages/grafana-ui/src/index.ts"),n=r("./public/app/features/explore/state/selectors.ts"),i=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),d=r("./.yarn/__virtual__/react-hook-form-virtual-92b6119fd4/3/opt/drone/yarncache/react-hook-form-npm-7.5.3-f9cc466c62-fbfaa3b664.zip/node_modules/react-hook-form/dist/index.esm.js"),c=r("./packages/grafana-data/src/index.ts"),l=r("./packages/grafana-runtime/src/index.ts"),u=r("./public/app/core/components/Select/DashboardPicker.tsx"),p=r("./public/app/features/dashboard/state/initDashboard.ts"),h=r("./public/app/core/services/backend_srv.ts");let b;async function f(e){var a;const r=function(e,a){for(const{refId:r}of e.filter(g)){const e=v(r);if(a.graphFrames.some(e))return"timeseries";if(a.logsFrames.some(e))return"logs";if(a.nodeGraphFrames.some(e))return"nodeGraph"}return"table"}(e.queries,e.queryResponse),t={targets:e.queries,type:r,title:"New Panel",gridPos:{x:0,y:0,w:12,h:8},datasource:e.datasource};let s;if(e.dashboardUid)try{s=await h.ae.getDashboardByUid(e.dashboardUid)}catch(e){throw b.FETCH_DASHBOARD}else s=function(){const e=(0,p.ZQ)();return e.dashboard.panels=[],e}();s.dashboard.panels=[t,...null!==(a=s.dashboard.panels)&&void 0!==a?a:[]];try{(0,p.$M)(s)}catch{throw b.SET_DASHBOARD_LS}}!function(e){e.FETCH_DASHBOARD="fetch-dashboard",e.SET_DASHBOARD_LS="set-dashboard-ls-error"}(b||(b={}));const g=e=>!e.hide,v=e=>a=>a.refId===e;var m=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const x=["ref"],S=["ref","value","onChange"];function y(e,a){if(null==e)return{};var r,t,s={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],a.indexOf(r)>=0||(s[r]=e[r]);return s}var w;!function(e){e.NewDashboard="new-dashboard",e.ExistingDashboard="existing-dashboard"}(w||(w={}));const D=[{label:"New dashboard",value:w.NewDashboard},{label:"Existing dashboard",value:w.ExistingDashboard}];var k;!function(e){e.UNKNOWN="unknown-error",e.NAVIGATION="navigation-error"}(k||(k={}));const j=e=>{let{onClose:a,exploreId:h}=e;const g=(0,s.useSelector)((0,n.F)(h)),[v,j]=(0,t.useState)(),{handleSubmit:_,control:N,formState:{errors:A},watch:T}=(0,d.cI)({defaultValues:{saveTarget:w.NewDashboard}}),U=T("saveTarget"),I=async(e,t)=>{j(void 0);const s=t.saveTarget===w.ExistingDashboard?t.dashboardUid:void 0;(0,l.reportInteraction)("e2d_submit",{newTab:e,saveTarget:t.saveTarget,queries:g.queries.length});try{var o;await f({dashboardUid:s,datasource:null===(o=g.datasourceInstance)||void 0===o?void 0:o.getRef(),queries:g.queries,queryResponse:g.queryResponse})}catch(e){switch(e){case b.FETCH_DASHBOARD:j({error:e,message:"Could not fetch dashboard information. Please try again."});break;case b.SET_DASHBOARD_LS:j({error:e,message:"Could not add panel to dashboard. Please try again."});break;default:j({error:k.UNKNOWN,message:"Something went wrong. Please try again."})}return}const n=function(e){return e?`d/${e}`:"dashboard/new"}(s);if(!e)return a(),void l.locationService.push(c.locationUtil.stripBaseFromUrl(n));if(!!!r.g.open(l.config.appUrl+n,"_blank"))return j({error:k.NAVIGATION,message:"Could not navigate to the selected dashboard. Please try again."}),void(0,p.f1)();a()};return(0,t.useEffect)((()=>{(0,l.reportInteraction)("e2d_open")}),[]),(0,m.jsx)(o.Modal,{title:"Add panel to dashboard",onDismiss:a,isOpen:!0,children:(0,m.jsxs)("form",{children:[(0,m.jsx)(o.InputControl,{control:N,render:e=>{let{}=e,a=y(e.field,x);return(0,m.jsx)(o.Field,{label:"Target dashboard",description:"Choose where to add the panel.",children:(0,m.jsx)(o.RadioButtonGroup,Object.assign({options:D},a,{id:"e2d-save-target"}))})},name:"saveTarget"}),U===w.ExistingDashboard&&(0,m.jsx)(o.InputControl,{render:e=>{var a;let{field:{onChange:r}}=e,t=y(e.field,S);return(0,m.jsx)(o.Field,{label:"Dashboard",description:"Select in which dashboard the panel will be created.",error:null===(a=A.dashboardUid)||void 0===a?void 0:a.message,invalid:!!A.dashboardUid,children:(0,m.jsx)(u.o,Object.assign({},t,{inputId:"e2d-dashboard-picker",defaultOptions:!0,onChange:e=>r(null==e?void 0:e.uid)}))})},control:N,name:"dashboardUid",shouldUnregister:!0,rules:{required:{value:!0,message:"This field is required."}}}),v&&(0,m.jsx)(o.Alert,{severity:"error",title:"Error adding the panel",children:v.message}),(0,m.jsxs)(o.Modal.ButtonRow,{children:[(0,m.jsx)(o.Button,{type:"reset",onClick:a,fill:"outline",variant:"secondary",children:"Cancel"}),(0,m.jsx)(o.Button,{type:"submit",variant:"secondary",onClick:_((0,i.partial)(I,!0)),icon:"external-link-alt",children:"Open in new tab"}),(0,m.jsx)(o.Button,{type:"submit",variant:"primary",onClick:_((0,i.partial)(I,!1)),icon:"apps",children:"Open dashboard"})]})]})})},_=e=>{var a,r;let{exploreId:i}=e;const[d,c]=(0,t.useState)(!1),l=(0,n.F)(i),u=!(null===(a=(0,s.useSelector)(l))||void 0===a||null===(r=a.queries)||void 0===r||!r.length);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(o.ToolbarButton,{icon:"apps",onClick:()=>c(!0),"aria-label":"Add to dashboard",disabled:!u,children:"Add to dashboard"}),d&&(0,m.jsx)(j,{onClose:()=>c(!1),exploreId:i})]})}}}]);
//# sourceMappingURL=5204.b208037f6b1954dc031d.js.map
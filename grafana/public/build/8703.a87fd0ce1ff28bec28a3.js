"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8703],{"./public/app/plugins/datasource/loki/components/LokiQueryField.tsx":(e,s,t)=>{t.d(s,{n:()=>k});var a=t("./.yarn/cache/prismjs-npm-1.27.0-ca4e1667c6-85c7f4a3e9.zip/node_modules/prismjs/prism.js"),l=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),i=t("./packages/grafana-ui/src/index.ts"),n=t("./public/app/core/components/LocalStorageValueProvider/index.tsx");function o(e){return s=e/1e3,Math.floor(s/60);var s}var r,c,d,h,u=t("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/0/cache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),g=t("./.yarn/cache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),p=t("./.yarn/__virtual__/react-window-virtual-0f9a8c6a67/0/cache/react-window-npm-1.8.6-4f5a230226-54ccf2b16c.zip/node_modules/react-window/dist/index.esm.js"),b=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");function m(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}const v=1e3,f=1e4,x=4,y="{}";function w(e){const s=[];for(const t of e)if(t.selected&&t.values&&t.values.length>0){const e=t.values.filter((e=>e.selected)).map((e=>e.name));e.length>1?s.push(`${t.name}=~"${e.join("|")}"`):1===e.length&&s.push(`${t.name}="${e[0]}"`)}return["{",s.join(","),"}"].join("")}class j extends l.Component{constructor(){super(...arguments),m(this,"state",{labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""}),m(this,"onChangeSearch",(e=>{this.setState({searchTerm:e.target.value})})),m(this,"onClickRunLogsQuery",(()=>{const e=w(this.state.labels);this.props.onChange(e)})),m(this,"onClickRunMetricsQuery",(()=>{const e=`rate(${w(this.state.labels)}[$__interval])`;this.props.onChange(e)})),m(this,"onClickClear",(()=>{this.setState((e=>({labels:e.labels.map((e=>Object.assign({},e,{values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0}))),searchTerm:"",status:"",error:"",validationStatus:""}))),this.props.deleteLastUsedLabels()})),m(this,"onClickLabel",((e,s,t)=>{const a=this.state.labels.find((s=>s.name===e));if(!a)return;const l=!a.selected;let i={selected:l};if(a.values&&!l){const e=a.values.map((e=>Object.assign({},e,{selected:!1})));i=Object.assign({},i,{facets:0,values:e})}this.setState({searchTerm:""}),this.updateLabelState(e,i,"",(()=>this.doFacettingForLabel(e)))})),m(this,"onClickValue",((e,s,t)=>{const a=this.state.labels.find((s=>s.name===e));if(!a||!a.values)return;this.setState({searchTerm:""});const l=a.values.map((e=>Object.assign({},e,{selected:e.name===s?!e.selected:e.selected})));this.updateLabelState(e,{values:l},"",(()=>this.doFacetting(e)))})),m(this,"onClickValidate",(()=>{const e=w(this.state.labels);this.validateSelector(e)})),m(this,"doFacetting",(e=>{const s=w(this.state.labels);if(s===y){const e=this.state.labels.map((e=>Object.assign({},e,{facets:0,values:void 0,hidden:!1})));this.setState({labels:e},(()=>{this.state.labels.forEach((e=>e.selected&&this.fetchValues(e.name,s)))}))}else this.fetchSeries(s,e)}))}updateLabelState(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3?arguments[3]:void 0;this.setState((a=>{const l=a.labels.map((t=>t.name===e?Object.assign({},t,s):t)),i=t?"":a.error;return{labels:l,status:t,error:i,validationStatus:""}}),a)}componentDidMount(){const{languageProvider:e,autoSelect:s=x,lastUsedLabels:t}=this.props;if(e){const a=t;e.start().then((()=>{let t=e.getLabelKeys();if(t.length>v){const e=`Too many labels found (showing only 1000 of ${t.length})`;t=t.slice(0,v),this.setState({error:e})}const l=t.map(((e,t,l)=>({name:e,selected:l.length<=s&&0===a.length||a.includes(e),loading:!1})));this.setState({labels:l},(()=>{this.state.labels.forEach((e=>{e.selected&&this.fetchValues(e.name,y)}))}))}))}}doFacettingForLabel(e){const s=this.state.labels.find((s=>s.name===e));if(!s)return;const t=this.state.labels.filter((e=>e.selected)).map((e=>e.name));this.props.storeLastUsedLabels(t),s.selected?s.values||this.fetchValues(e,w(this.state.labels)):this.doFacetting()}async fetchValues(e,s){const{languageProvider:t}=this.props;this.updateLabelState(e,{loading:!0},`Fetching values for ${e}`);try{let a=await t.getLabelValues(e);if(s!==w(this.state.labels))return void this.updateLabelState(e,{loading:!1},"");if(a.length>f){const s=`Too many values for ${e} (showing only 10000 of ${a.length})`;a=a.slice(0,f),this.setState({error:s})}const l=a.map((e=>({name:e})));this.updateLabelState(e,{values:l,loading:!1})}catch(e){console.error(e)}}async fetchSeries(e,s){const{languageProvider:t}=this.props;s&&this.updateLabelState(s,{loading:!0},`Facetting labels for ${e}`);try{const a=await t.fetchSeriesLabels(e,!0);if(e!==w(this.state.labels))return void(s&&this.updateLabelState(s,{loading:!1}));if(0===Object.keys(a).length)return void this.setState({error:`Empty results, no matching label for ${e}`});const l=function(e,s,t){return e.map((e=>{const a=s[e.name];if(a){let s;if(e.name===t&&e.values)s=e.values;else{var l;const t=new Set((null===(l=e.values)||void 0===l?void 0:l.filter((e=>e.selected)).map((e=>e.name)))||[]);s=a.map((e=>({name:e,selected:t.has(e)})))}return Object.assign({},e,{loading:!1,values:s,facets:s.length})}return Object.assign({},e,{loading:!1,hidden:!a,values:void 0,facets:0})}))}(this.state.labels,a,s);this.setState({labels:l,error:""}),s&&this.updateLabelState(s,{loading:!1})}catch(e){console.error(e)}}async validateSelector(e){const{languageProvider:s}=this.props;this.setState({validationStatus:`Validating selector ${e}`,error:""});const t=await s.fetchSeries(e);this.setState({validationStatus:`Selector is valid (${t.length} streams found)`})}render(){const{theme:e}=this.props,{labels:s,searchTerm:t,status:a,error:l,validationStatus:n}=this.state;if(0===s.length)return r||(r=(0,b.jsx)(i.LoadingPlaceholder,{text:"Loading labels..."}));const o=(e=>({wrapper:u.css`
    background-color: ${e.colors.background.secondary};
    padding: ${e.spacing(2)};
    width: 100%;
  `,list:u.css`
    margin-top: ${e.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:u.css`
    & + & {
      margin: ${e.spacing(2,0)};
    }
    position: relative;
  `,selector:u.css`
    font-family: ${e.typography.fontFamilyMonospace};
    margin-bottom: ${e.spacing(1)};
  `,status:u.css`
    padding: ${e.spacing(.5)};
    color: ${e.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* using absolute positioning because flex interferes with ellipsis */
    position: absolute;
    width: 50%;
    right: 0;
    text-align: right;
    transition: opacity 100ms linear;
    opacity: 0;
  `,statusShowing:u.css`
    opacity: 1;
  `,error:u.css`
    color: ${e.colors.error.main};
  `,valueList:u.css`
    margin-right: ${e.spacing(1)};
  `,valueListWrapper:u.css`
    border-left: 1px solid ${e.colors.border.medium};
    margin: ${e.spacing(1,0)};
    padding: ${e.spacing(1,0,1,1)};
  `,valueListArea:u.css`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${e.spacing(1)};
  `,valueTitle:u.css`
    margin-left: -${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
  `,validationStatus:u.css`
    padding: ${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
    color: ${e.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `}))(e),m=w(this.state.labels),v=m===y;let f=s.filter((e=>e.selected&&e.values));return f=t?f.map((e=>{const s=e.values.filter((e=>{if(e.selected)return e.highlightParts=void 0,!0;const s=(0,i.fuzzyMatch)(e.name.toLowerCase(),t.toLowerCase());return!!s.found&&(e.highlightParts=s.ranges,e.order=s.distance,!0)}));return Object.assign({},e,{values:(0,g.sortBy)(s,(e=>e.selected?-1/0:e.order))})})):this.state.labels.filter((e=>e.selected&&e.values)).map((e=>Object.assign({},e,{values:null!=e&&e.values?e.values.map((e=>Object.assign({},e,{highlightParts:void 0}))):[]}))),(0,b.jsxs)("div",{className:o.wrapper,children:[(0,b.jsxs)("div",{className:o.section,children:[c||(c=(0,b.jsx)(i.Label,{description:"Which labels would you like to consider for your search?",children:"1. Select labels to search in"})),(0,b.jsx)("div",{className:o.list,children:s.map((e=>(0,b.jsx)(i.BrowserLabel,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets,onClick:this.onClickLabel},e.name)))})]}),(0,b.jsxs)("div",{className:o.section,children:[d||(d=(0,b.jsx)(i.Label,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels.",children:"2. Find values for the selected labels"})),(0,b.jsx)("div",{children:(0,b.jsx)(i.Input,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:t})}),(0,b.jsx)("div",{className:o.valueListArea,children:f.map((e=>{var s,a;return(0,b.jsxs)("div",{role:"list",className:o.valueListWrapper,children:[(0,b.jsx)("div",{className:o.valueTitle,"aria-label":`Values for ${e.name}`,children:(0,b.jsx)(i.BrowserLabel,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets||(null===(s=e.values)||void 0===s?void 0:s.length),onClick:this.onClickLabel})}),(0,b.jsx)(p.t7,{height:200,itemCount:(null===(a=e.values)||void 0===a?void 0:a.length)||0,itemSize:28,itemKey:s=>e.values[s].name,width:200,className:o.valueList,children:s=>{var a;let{index:l,style:n}=s;const o=null===(a=e.values)||void 0===a?void 0:a[l];return o?(0,b.jsx)("div",{style:n,children:(0,b.jsx)(i.BrowserLabel,{name:e.name,value:null==o?void 0:o.name,active:null==o?void 0:o.selected,highlightParts:null==o?void 0:o.highlightParts,onClick:this.onClickValue,searchTerm:t})}):null}})]},e.name)}))})]}),(0,b.jsxs)("div",{className:o.section,children:[h||(h=(0,b.jsx)(i.Label,{children:"3. Resulting selector"})),(0,b.jsx)("div",{"aria-label":"selector",className:o.selector,children:m}),n&&(0,b.jsx)("div",{className:o.validationStatus,children:n}),(0,b.jsxs)(i.HorizontalGroup,{children:[(0,b.jsx)(i.Button,{"aria-label":"Use selector as logs button",disabled:v,onClick:this.onClickRunLogsQuery,children:"Show logs"}),(0,b.jsx)(i.Button,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:v,onClick:this.onClickRunMetricsQuery,children:"Show logs rate"}),(0,b.jsx)(i.Button,{"aria-label":"Validate submit button",variant:"secondary",disabled:v,onClick:this.onClickValidate,children:"Validate selector"}),(0,b.jsx)(i.Button,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear,children:"Clear"}),(0,b.jsx)("div",{className:(0,u.cx)(o.status,(a||l)&&o.statusShowing),children:(0,b.jsx)("span",{className:l?o.error:"",children:l||a})})]})]})]})}}const L=(0,i.withTheme2)(j);function S(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}function C(e,s){let{typeaheadContext:t,typeaheadText:a}=s;switch(t){case"context-labels":{const s=i.DOMUtil.getNextCharacter();s&&"}"!==s&&","!==s||(e+="=");break}case"context-label-values":a.match(/^(!?=~?"|")/)||(e=`"${e}`),'"'!==i.DOMUtil.getNextCharacter()&&(e=`${e}"`)}return e}class k extends l.PureComponent{constructor(e){super(e),S(this,"plugins",void 0),S(this,"_isMounted",!1),S(this,"onChangeLabelBrowser",(e=>{this.onChangeQuery(e,!0),this.setState({labelBrowserVisible:!1})})),S(this,"onChangeQuery",((e,s)=>{const{query:t,onChange:a,onRunQuery:l}=this.props;if(a){a(Object.assign({},t,{expr:e})),s&&l&&l()}})),S(this,"onClickChooserButton",(()=>{this.setState((e=>({labelBrowserVisible:!e.labelBrowserVisible})))})),S(this,"onTypeahead",(async e=>{const{datasource:s}=this.props;if(!s.languageProvider)return{suggestions:[]};const t=s.languageProvider,{history:a}=this.props,{prefix:l,text:i,value:n,wrapperClasses:o,labelKey:r}=e;return await t.provideCompletionItems({text:i,value:n,prefix:l,wrapperClasses:o,labelKey:r},{history:a})})),this.state={labelsLoaded:!1,labelBrowserVisible:!1},this.plugins=[(0,i.BracesPlugin)(),(0,i.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"logql"},Object.assign({},a.languages,{logql:this.props.datasource.languageProvider.getSyntax()}))]}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(e){const{range:s,datasource:{languageProvider:t}}=this.props,a=function(e,s){if(e&&s){const t=o(e.from.valueOf())===o(s.from.valueOf()),a=o(e.to.valueOf())===o(s.to.valueOf());return!(t&&a)}return!1}(s,e.range);a&&t.fetchLabels()}render(){const{ExtraFieldElement:e,query:s,datasource:t,placeholder:a="Enter a Loki query (run with Shift+Enter)"}=this.props,{labelsLoaded:l,labelBrowserVisible:o}=this.state,r=t.languageProvider,c=t.languageProvider?r.cleanText:void 0,d=r.getLabelKeys().length>0,h=function(e,s){return e?s?"Log browser":"(No logs found)":"Loading labels..."}(l,d),u=!(l&&d);return(0,b.jsx)(n.G,{storageKey:"grafana.datasources.loki.browser.labels",defaultValue:[],children:(t,l,n)=>(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"],children:[(0,b.jsxs)("button",{className:"gf-form-label query-keyword pointer",onClick:this.onClickChooserButton,disabled:u,children:[h,(0,b.jsx)(i.Icon,{name:o?"angle-down":"angle-right"})]}),(0,b.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:(0,b.jsx)(i.QueryField,{additionalPlugins:this.plugins,cleanText:c,query:s.expr,onTypeahead:this.onTypeahead,onWillApplySuggestion:C,onChange:this.onChangeQuery,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery,placeholder:a,portalOrigin:"loki"})})]}),o&&(0,b.jsx)("div",{className:"gf-form",children:(0,b.jsx)(L,{languageProvider:r,onChange:this.onChangeLabelBrowser,lastUsedLabels:t||[],storeLastUsedLabels:l,deleteLastUsedLabels:n})}),e]})})}}}}]);
//# sourceMappingURL=8703.a87fd0ce1ff28bec28a3.js.map
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9897],{"./public/app/plugins/datasource/elasticsearch/module.ts":(e,t,i)=>{i.r(t),i.d(t,{plugin:()=>Mi});var s=i("./packages/grafana-data/src/index.ts"),n=i("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),a=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),l=i("./packages/grafana-ui/src/index.ts");const r=(e,t,i)=>(0,a.useCallback)((s=>{e(i(t,s))}),[e,t,i]),o=(0,a.createContext)(void 0),d=()=>{const e=(0,a.useContext)(o);if(!e)throw new Error("Use DispatchContext first.");return e},u=e=>({name:e,pipelineAgg:""}),c=e=>`var${Math.max(0,...e.map((e=>{var t;return parseInt((null===(t=e.name.match("^var(\\d+)$"))||void 0===t?void 0:t[1])||"0",10)})))+1}`,g=e=>{var t;return"ewma"===(null===(t=e.settings)||void 0===t?void 0:t.model)},p=e=>{var t;return"holt"===(null===(t=e.settings)||void 0===t?void 0:t.model)},m=e=>{var t;return"holt_winters"===(null===(t=e.settings)||void 0===t?void 0:t.model)},h=e=>{var t;return["holt","ewma","holt_winters"].includes((null===(t=e.settings)||void 0===t?void 0:t.model)||"")},v=e=>F[e.type].requiresField,f=e=>F[e.type].isPipelineAgg,b=e=>F[e.type].supportsMultipleBucketPaths,y=e=>F[e.type].supportsMissing,x=e=>F[e.type].hasSettings,j=e=>F[e.type].supportsInlineScript,_=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],F={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0 <8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,versionRange:">=7.0.0",defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,versionRange:">=2.0.0",hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[u(c([]))]}},raw_document:{label:"Raw Document (legacy)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",xpack:!0,requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,versionRange:">=7.7.0",hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",xpack:!0,versionRange:">=7.10.0",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},k={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},w=(e,t)=>{const i=t.filter((t=>{var i;return b(t)?null===(i=t.pipelineVariables)||void 0===i?void 0:i.some((t=>t.pipelineAgg===e.id)):v(t)&&e.id===t.field}));return[...i,...i.flatMap((e=>w(e,t)))]},S=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],I=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],O="@HIGHLIGHT@",q="@/HIGHLIGHT@";function M(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"count",id:e}}function A(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"date_histogram",id:e,settings:{interval:"auto"}}}const N=(e,t)=>e.find((e=>e.id===t));function C(e,t){var i;return!(null==e||null===(i=e.metrics)||void 0===i||!i.some((e=>e.type===t)))}var P=i("../../opt/drone/yarncache/semver-npm-7.3.5-618cf5db6a-5eafe6102b.zip/node_modules/semver/index.js");const V=e=>v(e)?`${F[e.type].label} ${e.field}`:F[e.type].label,D=e=>Object.entries(e).reduce(((e,t)=>{let[i,s]=t;if(null==s)return Object.assign({},e);if(Array.isArray(s)&&0===s.length)return Object.assign({},e);if(0===(null==s?void 0:s.length))return Object.assign({},e);if(!Array.isArray(s)&&"object"==typeof s){const t=D(s);return 0===Object.keys(t).length?Object.assign({},e):Object.assign({},e,{[i]:t})}return Object.assign({},e,{[i]:s})}),{}),$=e=>{const t=e.match(/^(\d+)/);return t?t[1]:void 0},T=e=>{var t,i,s,n;return("object"==typeof(null===(t=e.settings)||void 0===t?void 0:t.script)?null===(i=e.settings)||void 0===i||null===(s=i.script)||void 0===s?void 0:s.inline:null===(n=e.settings)||void 0===n?void 0:n.script)||""},L=e=>{if("string"==typeof e)return(0,P.valid)(e)||"5.0.0";switch(e){case 2:return"2.0.0";case 56:return"5.6.0";case 60:return"6.0.0";case 70:return"7.0.0";default:return"5.0.0"}};var B=i("./.yarn/__virtual__/@reduxjs-toolkit-virtual-7692db070f/3/opt/drone/yarncache/@reduxjs-toolkit-npm-1.7.2-7ced4ba4dc-41c17c660f.zip/node_modules/@reduxjs/toolkit/dist/redux-toolkit.esm.js");const R=(0,B.PH)("@metrics/add"),z=(0,B.PH)("@metrics/remove"),E=(0,B.PH)("@metrics/toggle_visibility"),W=(0,B.PH)("@metrics/change_field"),H=(0,B.PH)("@metrics/change_type"),Q=(0,B.PH)("@metrics/change_attr"),U=(0,B.PH)("@metrics/change_setting"),Y=(0,B.PH)("@metrics/change_meta"),G=(0,B.PH)("init"),Z=(0,B.PH)("change_query"),J=(0,B.PH)("change_alias_pattern"),K=(e,t)=>Z.match(t)?t.payload:G.match(t)?e||"":e,X=(e,t)=>J.match(t)?t.payload:G.match(t)?e||"":e,ee={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[{label:"",query:"*"}]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:s.InternalTimeZones.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}}},te=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],ie=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],se=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],ne=(0,B.PH)("@bucketAggs/add"),ae=(0,B.PH)("@bucketAggs/remove"),le=(0,B.PH)("@bucketAggs/change_type"),re=(0,B.PH)("@bucketAggs/change_field"),oe=(0,B.PH)("@bucketAggs/change_setting"),de=(e,t)=>{if(R.match(t))return[...e,M(t.payload)];if(z.match(t)){const i=e.find((e=>e.id===t.payload)),s=[i,...w(i,e)],n=e.filter((e=>!s.some((t=>t.id===e.id))));return 0===n.length?[M("1")]:n}return H.match(t)?e.filter((e=>!F[t.payload.type].isSingleMetric||e.id===t.payload.id)).map((e=>e.id!==t.payload.id?e:Object.assign({id:e.id,type:t.payload.type},F[t.payload.type].defaults))):W.match(t)?e.map((e=>{if(e.id!==t.payload.id)return e;const i=Object.assign({},e,{field:t.payload.field});return f(e)?Object.assign({},i,{pipelineAgg:t.payload.field}):i})):E.match(t)?e.map((e=>e.id!==t.payload?e:Object.assign({},e,{hide:!e.hide}))):U.match(t)?e.map((e=>{if(e.id!==t.payload.metric.id)return e;if(x(e)){const i=D(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})}return e})):Y.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:(e=>F[e.type].hasMeta)(e)?Object.assign({},e,{meta:Object.assign({},e.meta,{[t.payload.meta]:t.payload.newValue})}):e)):Q.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:Object.assign({},e,{[t.payload.attribute]:t.payload.newValue}))):G.match(t)?null!=e&&e.length?e:[M("1")]:e};var ue=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const ce=(0,a.createContext)(void 0),ge=(0,a.createContext)(void 0),pe=(0,a.createContext)(void 0),me=e=>{let{children:t,onChange:i,onRunQuery:s,query:n,datasource:l,range:d}=e;const u=(0,a.useCallback)((e=>{i(e),s()}),[i,s]),c=(g={query:K,alias:X,metrics:de,bucketAggs:(p=l.timeField,(e,t)=>{if(ne.match(t)){const i={id:t.payload,type:"terms",settings:ee.terms.defaultSettings},s=e[e.length-1];return"date_histogram"===(null==s?void 0:s.type)?[...e.slice(0,e.length-1),i,s]:[...e,i]}return ae.match(t)?e.filter((e=>e.id!==t.payload)):le.match(t)?e.map((e=>e.id!==t.payload.id?e:{id:e.id,type:t.payload.newType,settings:ee[t.payload.newType].defaultSettings})):re.match(t)?e.map((e=>e.id!==t.payload.id?e:Object.assign({},e,{field:t.payload.newField}))):H.match(t)?F[t.payload.type].isSingleMetric?[]:0===e.length?[Object.assign({},A("2"),{field:p})]:e:oe.match(t)?e.map((e=>{if(e.id!==t.payload.bucketAgg.id)return e;const i=D(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})})):G.match(t)?null!=e&&e.length?e:[Object.assign({},A("2"),{field:p})]:e})},(e,t)=>{const i={};for(const s in g)i[s]=g[s](e[s],t);return i});var g,p;const m=r((e=>u(Object.assign({},n,e,{timeField:l.timeField}))),n,c);return n.metrics&&n.bucketAggs&&void 0!==n.query?(0,ue.jsx)(ce.Provider,{value:l,children:(0,ue.jsx)(ge.Provider,{value:n,children:(0,ue.jsx)(pe.Provider,{value:d,children:(0,ue.jsx)(o.Provider,{value:m,children:t})})})}):(m(G()),null)},he=e=>()=>{const t=(0,a.useContext)(e);if(!t)throw new Error("use ElasticsearchProvider first.");return t},ve=he(ge),fe=he(ce),be=he(pe),ye=e=>e.id,xe=e=>parseInt(e,10),je=["iconName","onClick","className","label"];const _e=n.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,Fe=e=>{let{iconName:t,onClick:i,className:s,label:a}=e,r=function(e,t){if(null==e)return{};var i,s,n={},a=Object.keys(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,je);return(0,ue.jsxs)("button",Object.assign({className:(0,n.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:i},r,{children:[(0,ue.jsx)("span",{className:_e,children:a}),(0,ue.jsx)(l.Icon,{name:t,"aria-hidden":"true"})]}))};var ke=i("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js");const we=e=>{let{children:t,label:i,onRemoveClick:s,onHideClick:n,hidden:a=!1}=e;const r=(0,l.useStyles2)(Se);return(0,ue.jsxs)(l.InlineFieldRow,{children:[(0,ue.jsx)(l.InlineSegmentGroup,{children:(0,ue.jsxs)(l.InlineLabel,{width:17,as:"div",children:[(0,ue.jsx)("span",{children:i}),(0,ue.jsxs)("span",{className:r.iconWrapper,children:[n&&(0,ue.jsx)(l.IconButton,{name:a?"eye-slash":"eye",onClick:n,surface:"header",size:"sm","aria-pressed":a,"aria-label":"hide metric",className:r.icon}),(0,ue.jsx)(l.IconButton,{name:"trash-alt",surface:"header",size:"sm",className:r.icon,onClick:s||ke.noop,disabled:!s,"aria-label":"remove metric"})]})]})}),t]})},Se=e=>({iconWrapper:n.css`
      display: flex;
    `,icon:n.css`
      color: ${e.colors.text.secondary};
      margin-left: ${e.spacing(.25)};
    `});var Ie=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js");const Oe=e=>ee[e.type].requiresField,qe=["date_histogram","histogram","terms","filters","geohash_grid"],Me=e=>{if(t=e,_.includes(t))return"cardinality"===e?[]:["number"];var t;if((e=>qe.includes(e))(e))switch(e){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Ae=e=>{let{text:t}=e;return{label:t,value:t}},Ne=e=>{const t=fe(),i=be(),s=Array.isArray(e)?e:Me(e);let n;return async e=>(n||(n=await(0,Ie.n)(t.getFields(s,i))),n.filter((t=>{let{text:i}=t;return void 0===e||i.includes(e)})).map(Ae))},Ce=n.css`
  min-width: 150px;
`,Pe=e=>{let{label:t,children:i,hidden:s=!1}=e;const[r,o]=(0,a.useState)(!1),d=((e,t)=>({wrapper:n.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:n.css`
      padding-top: ${e.spacing(.5)};
    `,icon:n.css`
      margin-right: ${e.spacing(.5)};
    `,button:n.css`
      justify-content: start;
      ${t&&n.css`
        color: ${e.colors.text.disabled};
      `}
    `}))((0,l.useTheme2)(),s);return(0,ue.jsx)(l.InlineSegmentGroup,{children:(0,ue.jsxs)("div",{className:(0,n.cx)(d.wrapper),children:[(0,ue.jsxs)("button",{className:(0,n.cx)("gf-form-label query-part",d.button,Ce),onClick:()=>o(!r),"aria-expanded":r,children:[(0,ue.jsx)(l.Icon,{name:r?"angle-down":"angle-right","aria-hidden":"true",className:d.icon}),t]}),r&&(0,ue.jsx)("div",{className:d.settingsWrapper,children:i})]})})},Ve=e=>{let{options:t,value:i,onChange:s}=e;const[n,l]=(0,a.useState)(((e,t)=>{return void 0===t||e.some((i=t,e=>{let{value:t}=e;return t===i}))?e:[...e,{value:t,label:t}];var i})(t,i));return{onCreateOption:e=>{var t;t=e,l([...n,{value:t,label:t}]),s({value:e})},onChange:s,allowCustomValue:!0,options:n,value:i}},De=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],$e=(e,t,i)=>{var s;return!i.some((s=e,e=>{let{value:t}=e;return t===s}))&&e.trim().length>0},Te=(e,t)=>{var i;return(null===(i=e.value)||void 0===i?void 0:i.startsWith(t))||!1},Le=e=>{var t,i,n,r,o,u,c,g,p,m;let{bucketAgg:h}=e;const v=d(),{current:f}=(0,a.useRef)((0,ke.uniqueId)("es-date_histogram-"));return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,Object.assign({label:"Interval"},Ke,{children:(0,ue.jsx)(l.Select,Object.assign({menuShouldPortal:!0,inputId:(0,ke.uniqueId)("es-date_histogram-interval"),isValidNewOption:$e,filterOption:Te},Ve({options:De,value:(null===(t=h.settings)||void 0===t?void 0:t.interval)||(null===(i=ee.date_histogram.defaultSettings)||void 0===i?void 0:i.interval),onChange:e=>{let{value:t}=e;return v(oe({bucketAgg:h,settingName:"interval",newValue:t}))}})))})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Min Doc Count"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${f}-min_doc_count`,onBlur:e=>v(oe({bucketAgg:h,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(n=h.settings)||void 0===n?void 0:n.min_doc_count)||(null===(r=ee.date_histogram.defaultSettings)||void 0===r?void 0:r.min_doc_count)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Trim Edges"},Ke,{tooltip:"Trim the edges on the timeseries datapoints",children:(0,ue.jsx)(l.Input,{id:`${f}-trime_edges`,onBlur:e=>v(oe({bucketAgg:h,settingName:"trimEdges",newValue:e.target.value})),defaultValue:(null===(o=h.settings)||void 0===o?void 0:o.trimEdges)||(null===(u=ee.date_histogram.defaultSettings)||void 0===u?void 0:u.trimEdges)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Offset"},Ke,{tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day",children:(0,ue.jsx)(l.Input,{id:`${f}-offset`,onBlur:e=>v(oe({bucketAgg:h,settingName:"offset",newValue:e.target.value})),defaultValue:(null===(c=h.settings)||void 0===c?void 0:c.offset)||(null===(g=ee.date_histogram.defaultSettings)||void 0===g?void 0:g.offset)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Timezone"},Ke,{children:(0,ue.jsx)(l.TimeZonePicker,{value:(null===(p=h.settings)||void 0===p?void 0:p.timeZone)||(null===(m=ee.date_histogram.defaultSettings)||void 0===m?void 0:m.timeZone),includeInternal:[s.InternalTimeZones.utc],onChange:e=>{v(oe({bucketAgg:h,settingName:"timeZone",newValue:e}))}})}))]})},Be=e=>{let{index:t,onAdd:i,onRemove:s,elements:a}=e;return(0,ue.jsxs)("div",{className:n.css`
        display: flex;
      `,children:[0===t&&(0,ue.jsx)(Fe,{iconName:"plus",onClick:i,label:"add"}),a.length>=2&&(0,ue.jsx)(Fe,{iconName:"minus",onClick:s,label:"remove"})]})},Re=(0,B.PH)("@bucketAggregations/filter/add"),ze=(0,B.PH)("@bucketAggregations/filter/remove"),Ee=(0,B.PH)("@bucketAggregations/filter/change"),We=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return Re.match(t)?[...e,{label:"",query:"*"}]:ze.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):Ee.match(t)?e.map(((e,i)=>i!==t.payload.index?e:t.payload.filter)):e},He=e=>{var t,i,s,o;let{bucketAgg:u}=e;const{current:c}=(0,a.useRef)((0,ke.uniqueId)("es-filters-")),g=d(),p=r((e=>g(oe({bucketAgg:u,settingName:"filters",newValue:e}))),null===(t=u.settings)||void 0===t?void 0:t.filters,We);return(0,a.useEffect)((()=>{var e,t;null!==(e=u.settings)&&void 0!==e&&null!==(t=e.filters)&&void 0!==t&&t.length||p(Re())}),[p,null===(i=u.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.length]),(0,ue.jsx)(ue.Fragment,{children:(0,ue.jsx)("div",{className:n.css`
          display: flex;
          flex-direction: column;
        `,children:null===(o=u.settings)||void 0===o?void 0:o.filters.map(((e,t)=>{var i;return(0,ue.jsxs)("div",{className:n.css`
              display: flex;
            `,children:[(0,ue.jsx)(l.InlineField,{label:"Query",labelWidth:8,children:(0,ue.jsx)("div",{className:n.css`
                  width: 150px;
                `,children:(0,ue.jsx)(l.QueryField,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:i=>p(Ee({index:t,filter:Object.assign({},e,{query:i})})),query:e.query})})}),(0,ue.jsx)(l.InlineField,{label:"Label",labelWidth:8,children:(0,ue.jsx)(l.Input,{width:16,id:`${c}-label-${t}`,placeholder:"Label",onBlur:i=>p(Ee({index:t,filter:Object.assign({},e,{label:i.target.value})})),defaultValue:e.label})}),(0,ue.jsx)(Be,{index:t,elements:(null===(i=u.settings)||void 0===i?void 0:i.filters)||[],onAdd:()=>p(Re()),onRemove:()=>p(ze(t))})]},t)}))})})},Qe=e=>{var t,i,s,n,r,o,u,c,g,p;let{bucketAgg:m}=e;const{metrics:h}=ve(),v=Ze(h),{current:f}=(0,a.useRef)((0,ke.uniqueId)("es-terms-")),b=d();return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,Object.assign({label:"Order"},Ke,{children:(0,ue.jsx)(l.Select,{inputId:`${f}-order`,menuShouldPortal:!0,onChange:e=>b(oe({bucketAgg:m,settingName:"order",newValue:e.value})),options:ie,value:(null===(t=m.settings)||void 0===t?void 0:t.order)||(null===(i=ee.terms.defaultSettings)||void 0===i?void 0:i.order)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Size"},Ke,{children:(0,ue.jsx)(l.Select,Object.assign({inputId:`${f}-size`,menuShouldPortal:!0},Ve({options:se,value:(null===(s=m.settings)||void 0===s?void 0:s.size)||(null===(n=ee.terms.defaultSettings)||void 0===n?void 0:n.size),onChange(e){let{value:t}=e;b(oe({bucketAgg:m,settingName:"size",newValue:t}))}})))})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Min Doc Count"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${f}-min_doc_count`,onBlur:e=>b(oe({bucketAgg:m,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(r=m.settings)||void 0===r?void 0:r.min_doc_count)||(null===(o=ee.terms.defaultSettings)||void 0===o?void 0:o.min_doc_count)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Order By"},Ke,{children:(0,ue.jsx)(l.Select,{inputId:`${f}-order_by`,menuShouldPortal:!0,onChange:e=>b(oe({bucketAgg:m,settingName:"orderBy",newValue:e.value})),options:v,value:(null===(u=m.settings)||void 0===u?void 0:u.orderBy)||(null===(c=ee.terms.defaultSettings)||void 0===c?void 0:c.orderBy)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Missing"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${f}-missing`,onBlur:e=>b(oe({bucketAgg:m,settingName:"missing",newValue:e.target.value})),defaultValue:(null===(g=m.settings)||void 0===g?void 0:g.missing)||(null===(p=ee.terms.defaultSettings)||void 0===p?void 0:p.missing)})}))]})};function Ue(e){if(!e.meta)return[];return Object.keys(e.meta).filter((t=>{var i;return null===(i=e.meta)||void 0===i?void 0:i[t]})).map((t=>{let i=t;return"std_deviation_bounds_lower"===t&&(i="std_lower"),"std_deviation_bounds_upper"===t&&(i="std_upper"),{label:`${V(e)} (${i})`,value:`${e.id}[${i}]`}}))}function Ye(e){var t;return null!==(t=e.settings)&&void 0!==t&&t.percents?e.settings.percents.map((t=>{const i=/^\d+\.\d+/.test(`${t}`)?t:`${t}.0`;return{label:`${V(e)} (${t})`,value:`${e.id}[${i}]`}})):[]}function Ge(e){return"top_metrics"!==e.type&&!f(e)}const Ze=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const t=e.filter(Ge).flatMap((e=>"extended_stats"===e.type?Ue(e):"percentiles"===e.type?Ye(e):{label:V(e),value:e.id}));return[...te,...t]},Je=e=>t=>t.value===e,Ke={labelWidth:16},Xe=e=>{var t,i,s,n,r,o;let{bucketAgg:u}=e;const{current:c}=(0,a.useRef)((0,ke.uniqueId)("es-setting-")),g=d(),p=(e=>{const{metrics:t}=ve();switch(e.type){case"terms":{var i,s,n,a;const r=(null===(i=e.settings)||void 0===i?void 0:i.order)||"desc",o=(null===(s=e.settings)||void 0===s?void 0:s.size)||"10",d=parseInt((null===(n=e.settings)||void 0===n?void 0:n.min_doc_count)||"0",10),u=(null===(a=e.settings)||void 0===a?void 0:a.orderBy)||"_term";let c="";var l;if("0"!==o)c=`${null===(l=ie.find(Je(r)))||void 0===l?void 0:l.label} ${o}, `;d>0&&(c+=`Min Doc Count: ${d}, `),c+="Order by: ";const g=te.find(Je(u));if(g)c+=g.label;else{const e=null==t?void 0:t.find((e=>e.id===$(u)));c+=e?V(e):"metric not found"}return"0"===o&&(c+=` (${r})`),c}case"histogram":{var r,o;const t=(null===(r=e.settings)||void 0===r?void 0:r.interval)||1e3,i=(null===(o=e.settings)||void 0===o?void 0:o.min_doc_count)||1;return`Interval: ${t}${i>0?`, Min Doc Count: ${i}`:""}`}case"filters":var d,u;return`Filter Queries (${((null===(d=e.settings)||void 0===d?void 0:d.filters)||(null===(u=ee.filters.defaultSettings)||void 0===u?void 0:u.filters)).length})`;case"geohash_grid":var c;return`Precision: ${Math.max(Math.min(parseInt((null===(c=e.settings)||void 0===c?void 0:c.precision)||"5",10),12),1)}`;case"date_histogram":{var g,p,m;const t=(null===(g=e.settings)||void 0===g?void 0:g.interval)||"auto",i=(null===(p=e.settings)||void 0===p?void 0:p.min_doc_count)||0,s=(null===(m=e.settings)||void 0===m?void 0:m.trimEdges)||0;let n=`Interval: ${t}`;return i>0&&(n+=`, Min Doc Count: ${i}`),s>0&&(n+=`, Trim edges: ${s}`),n}default:return"Settings"}})(u);return(0,ue.jsxs)(Pe,{label:p,children:["terms"===u.type&&(0,ue.jsx)(Qe,{bucketAgg:u}),"date_histogram"===u.type&&(0,ue.jsx)(Le,{bucketAgg:u}),"filters"===u.type&&(0,ue.jsx)(He,{bucketAgg:u}),"geohash_grid"===u.type&&(0,ue.jsx)(l.InlineField,Object.assign({label:"Precision"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${c}-geohash_grid-precision`,onBlur:e=>g(oe({bucketAgg:u,settingName:"precision",newValue:e.target.value})),defaultValue:(null===(t=u.settings)||void 0===t?void 0:t.precision)||(null===(i=ee[u.type].defaultSettings)||void 0===i?void 0:i.precision)})})),"histogram"===u.type&&(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,Object.assign({label:"Interval"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${c}-histogram-interval`,onBlur:e=>g(oe({bucketAgg:u,settingName:"interval",newValue:e.target.value})),defaultValue:(null===(s=u.settings)||void 0===s?void 0:s.interval)||(null===(n=ee[u.type].defaultSettings)||void 0===n?void 0:n.interval)})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Min Doc Count"},Ke,{children:(0,ue.jsx)(l.Input,{id:`${c}-histogram-min_doc_count`,onBlur:e=>g(oe({bucketAgg:u,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(r=u.settings)||void 0===r?void 0:r.min_doc_count)||(null===(o=ee[u.type].defaultSettings)||void 0===o?void 0:o.min_doc_count)})}))]})]})},et=Object.entries(ee).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}})),tt=e=>{let{value:t}=e;const i=d(),s=Ne(t.type);return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsxs)(l.InlineSegmentGroup,{children:[(0,ue.jsx)(l.Segment,{className:Ce,options:et,onChange:e=>i(le({id:t.id,newType:e.value})),value:(n=t,{label:ee[n.type].label,value:n.type})}),Oe(t)&&(0,ue.jsx)(l.SegmentAsync,{className:Ce,loadOptions:s,onChange:e=>i(re({id:t.id,newField:e.value})),placeholder:"Select Field",value:t.field})]}),(0,ue.jsx)(Xe,{bucketAgg:t})]});var n},it=e=>{let{nextId:t}=e;const i=d(),{bucketAggs:s}=ve(),n=(null==s?void 0:s.length)||0;return(0,ue.jsx)(ue.Fragment,{children:s.map(((e,s)=>(0,ue.jsxs)(we,{label:0===s?"Group By":"Then By",onRemoveClick:n>1&&(()=>i(ae(e.id))),children:[(0,ue.jsx)(tt,{value:e}),0===s&&(0,ue.jsx)(Fe,{iconName:"plus",onClick:()=>i(ne(t)),label:"add"})]},`${e.type}-${e.id}`)))})},st=n.css`
  white-space: nowrap;
`,nt=e=>({label:V(e),value:e}),at=e=>{let{options:t,onChange:i,className:s,value:a}=e;const r=t.find((e=>e.id===a));return(0,ue.jsx)(l.Segment,{className:(0,n.cx)(s,st),options:(o=t,o.map(nt)),onChange:i,placeholder:"Select Metric",value:r?nt(r):void 0});var o};function lt(e){let{label:t,settingName:i,metric:s,placeholder:n,tooltip:r}=e;const o=d(),[u]=(0,a.useState)((0,ke.uniqueId)("es-field-id-")),c=s.settings;let g=(null==c?void 0:c[i])||"";return"script"===i&&(g=T(s)),(0,ue.jsx)(l.InlineField,{label:t,labelWidth:16,tooltip:r,children:(0,ue.jsx)(l.Input,{id:u,placeholder:n,onBlur:e=>o(U({metric:s,settingName:i,newValue:e.target.value})),defaultValue:g})})}const rt=(0,B.PH)("@pipelineVariables/add"),ot=(0,B.PH)("@pipelineVariables/remove"),dt=(0,B.PH)("@pipelineVariables/rename"),ut=(0,B.PH)("@pipelineVariables/change_metric"),ct=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return rt.match(t)?[...e,u(c(e))]:ot.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):dt.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{name:t.payload.newName}))):ut.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{pipelineAgg:t.payload.newMetric}))):e};var gt;const pt=e=>{var t;let{value:i,previousMetrics:s}=e;const o=d(),u=r((e=>o(Q({metric:i,attribute:"pipelineVariables",newValue:e}))),i.pipelineVariables,ct);return(0,a.useEffect)((()=>{var e;null!==(e=i.pipelineVariables)&&void 0!==e&&e.length||u(rt())}),[u,null===(t=i.pipelineVariables)||void 0===t?void 0:t.length]),(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsxs)("div",{className:n.css`
          display: flex;
        `,children:[gt||(gt=(0,ue.jsx)(l.InlineLabel,{width:16,children:"Variables"})),(0,ue.jsx)("div",{className:n.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `,children:i.pipelineVariables.map(((e,t)=>(0,ue.jsxs)(a.Fragment,{children:[(0,ue.jsxs)("div",{className:n.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `,children:[(0,ue.jsx)(l.Input,{"aria-label":"Variable name",defaultValue:e.name,placeholder:"Variable Name",onBlur:e=>u(dt({newName:e.target.value,index:t}))}),(0,ue.jsx)(at,{onChange:e=>u(ut({newMetric:e.value.id,index:t})),options:s,value:e.pipelineAgg})]}),(0,ue.jsx)(Be,{index:t,elements:i.pipelineVariables||[],onAdd:()=>u(rt()),onRemove:()=>u(ot(t))})]},(0,ke.uniqueId)("es-bs-"))))})]}),(0,ue.jsx)(lt,{label:"Script",metric:i,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"})]})},mt=e=>{var t,i,s,n,r,o,u,c,h,v,f,b;let{metric:y}=e;const x=d(),{current:j}=(0,a.useRef)((0,ke.uniqueId)("es-moving-avg-"));return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,{label:"Model",labelWidth:16,children:(0,ue.jsx)(l.Select,{inputId:`${j}-model`,menuShouldPortal:!0,onChange:e=>x(U({metric:y,settingName:"model",newValue:e.value})),options:I,value:null===(t=y.settings)||void 0===t?void 0:t.model})}),(0,ue.jsx)(lt,{label:"Window",settingName:"window",metric:y,placeholder:"5"}),(0,ue.jsx)(lt,{label:"Predict",settingName:"predict",metric:y}),(g(y)||p(y)||m(y))&&(0,ue.jsx)(l.InlineField,{label:"Alpha",labelWidth:16,children:(0,ue.jsx)(l.Input,{id:`${j}-alpha`,onBlur:e=>{var t;return x(U({metric:y,settingName:"settings",newValue:Object.assign({},null===(t=y.settings)||void 0===t?void 0:t.settings,{alpha:e.target.value})}))},defaultValue:null===(i=y.settings)||void 0===i||null===(s=i.settings)||void 0===s?void 0:s.alpha})}),(p(y)||m(y))&&(0,ue.jsx)(l.InlineField,{label:"Beta",labelWidth:16,children:(0,ue.jsx)(l.Input,{id:`${j}-beta`,onBlur:e=>{var t;return x(U({metric:y,settingName:"settings",newValue:Object.assign({},null===(t=y.settings)||void 0===t?void 0:t.settings,{beta:e.target.value})}))},defaultValue:null===(n=y.settings)||void 0===n||null===(r=n.settings)||void 0===r?void 0:r.beta})}),m(y)&&(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,{label:"Gamma",labelWidth:16,children:(0,ue.jsx)(l.Input,{id:`${j}-gamma`,onBlur:e=>{var t;return x(U({metric:y,settingName:"settings",newValue:Object.assign({},null===(t=y.settings)||void 0===t?void 0:t.settings,{gamma:e.target.value})}))},defaultValue:null===(o=y.settings)||void 0===o||null===(u=o.settings)||void 0===u?void 0:u.gamma})}),(0,ue.jsx)(l.InlineField,{label:"Period",labelWidth:16,children:(0,ue.jsx)(l.Input,{id:`${j}-period`,onBlur:e=>{var t;return x(U({metric:y,settingName:"settings",newValue:Object.assign({},null===(t=y.settings)||void 0===t?void 0:t.settings,{period:e.target.value})}))},defaultValue:null===(c=y.settings)||void 0===c||null===(h=c.settings)||void 0===h?void 0:h.period})}),(0,ue.jsx)(l.InlineField,{label:"Pad",labelWidth:16,children:(0,ue.jsx)(l.InlineSwitch,{id:`${j}-pad`,onChange:e=>{var t;return x(U({metric:y,settingName:"settings",newValue:Object.assign({},null===(t=y.settings)||void 0===t?void 0:t.settings,{pad:e.target.checked})}))},checked:!(null===(v=y.settings)||void 0===v||null===(f=v.settings)||void 0===f||!f.pad)})})]}),(g(y)||p(y)||m(y))&&(0,ue.jsx)(l.InlineField,{label:"Minimize",labelWidth:16,children:(0,ue.jsx)(l.InlineSwitch,{id:`${j}-minimize`,onChange:e=>x(U({metric:y,settingName:"minimize",newValue:e.target.checked})),checked:!(null===(b=y.settings)||void 0===b||!b.minimize)})})]})},ht=e=>({value:e,label:e}),vt=e=>{var t,i,s,a;let{metric:r}=e;const o=d(),u=Ne(["number","date"]),c=Ne(r.type);return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,{label:"Metrics",labelWidth:16,children:(0,ue.jsx)(l.AsyncMultiSelect,{menuShouldPortal:!0,onChange:e=>o(U({metric:r,settingName:"metrics",newValue:e.map((e=>e.value))})),loadOptions:c,value:null===(t=r.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.map(ht),closeMenuOnSelect:!1,defaultOptions:!0})}),(0,ue.jsx)(l.InlineField,{label:"Order",labelWidth:16,children:(0,ue.jsx)(l.Select,{menuShouldPortal:!0,onChange:e=>o(U({metric:r,settingName:"order",newValue:e.value})),options:ie,value:null===(s=r.settings)||void 0===s?void 0:s.order})}),(0,ue.jsx)(l.InlineField,{label:"Order By",labelWidth:16,className:n.css`
          & > div {
            width: 100%;
          }
        `,children:(0,ue.jsx)(l.SegmentAsync,{className:n.css`
            margin-right: 0;
          `,loadOptions:u,onChange:e=>o(U({metric:r,settingName:"orderBy",newValue:e.value})),placeholder:"Select Field",value:null===(a=r.settings)||void 0===a?void 0:a.orderBy})})]})},ft={labelWidth:16},bt=e=>{var t,i,s,n,r,o,u;let{metric:c,previousMetrics:g}=e;const{current:p}=(0,a.useRef)((0,ke.uniqueId)("es-setting-")),m=d(),h=(e=>{var t,i,s;switch(e.type){case"cardinality":var n;return`Precision threshold: ${(null===(n=e.settings)||void 0===n?void 0:n.precision_threshold)||""}`;case"percentiles":var a;return null!==(t=e.settings)&&void 0!==t&&t.percents&&(null===(i=e.settings)||void 0===i||null===(s=i.percents)||void 0===s?void 0:s.length)>=1?`Values: ${null===(a=e.settings)||void 0===a?void 0:a.percents}`:"Percents: Default";case"extended_stats":{const t=Object.entries(e.meta||{}).map((e=>{var t;let[i,s]=e;return s&&(null===(t=S.find((e=>t=>t.value===e)(i)))||void 0===t?void 0:t.label)})).filter(Boolean);return`Stats: ${t.length>0?t.join(", "):"None selected"}`}case"raw_document":case"raw_data":var l;return`Size: ${(null===(l=e.settings)||void 0===l?void 0:l.size)||500}`;default:return"Options"}})(c),v=ve();return(0,ue.jsxs)(Pe,{label:h,hidden:c.hide,children:["derivative"===c.type&&(0,ue.jsx)(lt,{label:"Unit",metric:c,settingName:"unit"}),"serial_diff"===c.type&&(0,ue.jsx)(lt,{label:"Lag",metric:c,settingName:"lag",placeholder:"1"}),"cumulative_sum"===c.type&&(0,ue.jsx)(lt,{label:"Format",metric:c,settingName:"format"}),"moving_avg"===c.type&&(0,ue.jsx)(mt,{metric:c}),"moving_fn"===c.type&&(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(lt,{label:"Window",metric:c,settingName:"window"}),(0,ue.jsx)(lt,{label:"Script",metric:c,settingName:"script"}),(0,ue.jsx)(lt,{label:"Shift",metric:c,settingName:"shift"})]}),"top_metrics"===c.type&&(0,ue.jsx)(vt,{metric:c}),"bucket_script"===c.type&&(0,ue.jsx)(pt,{value:c,previousMetrics:g}),("raw_data"===c.type||"raw_document"===c.type)&&(0,ue.jsx)(l.InlineField,Object.assign({label:"Size"},ft,{children:(0,ue.jsx)(l.Input,{id:`ES-query-${v.refId}_metric-${c.id}-size`,onBlur:e=>m(U({metric:c,settingName:"size",newValue:e.target.value})),defaultValue:null!==(t=null===(i=c.settings)||void 0===i?void 0:i.size)&&void 0!==t?t:null===(s=F.raw_data.defaults.settings)||void 0===s?void 0:s.size})})),"logs"===c.type&&(0,ue.jsx)(lt,{label:"Limit",metric:c,settingName:"limit",placeholder:"500"}),"cardinality"===c.type&&(0,ue.jsx)(lt,{label:"Precision Threshold",metric:c,settingName:"precision_threshold"}),"extended_stats"===c.type&&(0,ue.jsxs)(ue.Fragment,{children:[S.map((e=>{var t,i,s;return(0,ue.jsx)(yt,{stat:e,onChange:t=>m(Y({metric:c,meta:e.value,newValue:t})),value:void 0!==(null===(t=c.meta)||void 0===t?void 0:t[e.value])?!(null===(i=c.meta)||void 0===i||!i[e.value]):!(null===(s=F.extended_stats.defaults.meta)||void 0===s||!s[e.value])},e.value)})),(0,ue.jsx)(lt,{label:"Sigma",metric:c,settingName:"sigma",placeholder:"3"})]}),"percentiles"===c.type&&(0,ue.jsx)(l.InlineField,Object.assign({label:"Percentiles"},ft,{children:(0,ue.jsx)(l.Input,{id:`${p}-percentiles-percents`,onBlur:e=>m(U({metric:c,settingName:"percents",newValue:e.target.value.split(",").filter(Boolean)})),defaultValue:(null===(n=c.settings)||void 0===n?void 0:n.percents)||(null===(r=F.percentiles.defaults.settings)||void 0===r?void 0:r.percents),placeholder:"1,5,25,50,75,95,99"})})),"rate"===c.type&&(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(l.InlineField,Object.assign({label:"Unit"},ft,{"data-testid":"unit-select",children:(0,ue.jsx)(l.Select,{menuShouldPortal:!0,id:`ES-query-${v.refId}_metric-${c.id}-unit`,onChange:e=>m(U({metric:c,settingName:"unit",newValue:e.value})),options:[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],value:null===(o=c.settings)||void 0===o?void 0:o.unit})})),(0,ue.jsx)(l.InlineField,Object.assign({label:"Mode"},ft,{"data-testid":"mode-select",children:(0,ue.jsx)(l.Select,{menuShouldPortal:!0,id:`ES-query-${v.refId}_metric-${c.id}-mode`,onChange:e=>m(U({metric:c,settingName:"mode",newValue:e.value})),options:[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}],value:null===(u=c.settings)||void 0===u?void 0:u.unit})}))]}),j(c)&&(0,ue.jsx)(lt,{label:"Script",metric:c,settingName:"script",placeholder:"_value * 1"}),y(c)&&(0,ue.jsx)(lt,{label:"Missing",metric:c,settingName:"missing",tooltip:"The missing parameter defines how documents that are missing a value should be treated. By default they will be ignored but it is also possible to treat them as if they had a value"})]})},yt=e=>{let{stat:t,onChange:i,value:s}=e;const[n]=(0,a.useState)((0,ke.uniqueId)("es-field-id-"));return(0,a.createElement)(l.InlineField,Object.assign({label:t.label},ft,{key:t.value}),(0,ue.jsx)(l.InlineSwitch,{id:n,onChange:e=>i(e.target.checked),value:s}))},xt=e=>!F[e.type].isPipelineAgg,jt=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=e.some(xt);return Object.entries(F).filter((e=>{let[i,{versionRange:s="*"}]=e;return(0,P.satisfies)(t,s)})).filter((e=>{let[t,i]=e;return s||!i.isPipelineAgg})).filter((e=>{let[t,s]=e;return!s.xpack||i})).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}}))},_t=e=>{let{value:t}=e;const i=(s=(0,l.useTheme2)(),{color:(r=!!t.hide)&&n.css`
        &,
        &:hover,
        label,
        a {
          color: ${r?s.colors.text.disabled:s.colors.text.primary};
        }
      `});var s,r;const o=fe(),u=ve(),c=d(),g=Ne(t.type),p=(0,a.useCallback)((async()=>{const e=await g();return j(t)?[{label:"None"},...e]:e}),[g,t]),m=u.metrics.slice(0,u.metrics.findIndex((e=>e.id===t.id)));return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsxs)(l.InlineSegmentGroup,{children:[(0,ue.jsx)(l.Segment,{className:(0,n.cx)(i.color,Ce),options:jt(m,o.esVersion,o.xpack),onChange:e=>c(H({id:t.id,type:e.value})),value:(h=t,{label:F[h.type].label,value:h.type})}),v(t)&&!f(t)&&(0,ue.jsx)(l.SegmentAsync,{className:(0,n.cx)(i.color,Ce),loadOptions:p,onChange:e=>c(W({id:t.id,field:e.value})),placeholder:"Select Field",value:t.field}),f(t)&&!b(t)&&(0,ue.jsx)(at,{className:(0,n.cx)(i.color,Ce),onChange:e=>{var i;return c(W({id:t.id,field:null===(i=e.value)||void 0===i?void 0:i.id}))},options:m,value:t.field})]}),x(t)&&(0,ue.jsx)(bt,{metric:t,previousMetrics:m})]});var h},Ft=e=>{let{nextId:t}=e;const i=d(),{metrics:s}=ve(),n=(null==s?void 0:s.length)||0;return(0,ue.jsx)(ue.Fragment,{children:null==s?void 0:s.map(((e,s)=>(0,ue.jsxs)(we,{label:`Metric (${e.id})`,hidden:e.hide,onHideClick:()=>i(E(e.id)),onRemoveClick:n>1&&(()=>i(z(e.id))),children:[(0,ue.jsx)(_t,{value:e}),!F[e.type].isSingleMetric&&0===s&&(0,ue.jsx)(Fe,{iconName:"plus",onClick:()=>i(R(t)),label:"add"})]},`${e.type}-${e.id}`)))})};var kt;const wt=e=>({root:n.css`
    display: flex;
  `,queryFieldWrapper:n.css`
    flex-grow: 1;
    margin: 0 ${e.spacing(.5)} ${e.spacing(.5)} 0;
  `}),St=e=>{var t,i,s;let{value:n}=e;const r=d(),o=(()=>{const{metrics:e,bucketAggs:t}=ve();return(0,a.useMemo)((()=>(Math.max(...[...(null==e?void 0:e.map(ye))||["0"],...(null==t?void 0:t.map(ye))||["0"]].map(xe))+1).toString()),[e,t])})(),u=(0,l.useStyles2)(wt),c="date_histogram"===(null===(t=n.bucketAggs)||void 0===t||null===(i=t.slice(-1)[0])||void 0===i?void 0:i.type),g=null===(s=n.metrics)||void 0===s?void 0:s.every((e=>!F[e.type].isSingleMetric));return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsxs)("div",{className:u.root,children:[kt||(kt=(0,ue.jsx)(l.InlineLabel,{width:17,children:"Query"})),(0,ue.jsx)("div",{className:u.queryFieldWrapper,children:(0,ue.jsx)(l.QueryField,{query:n.query,onBlur:()=>{},onChange:e=>r(Z(e)),placeholder:"Lucene Query",portalOrigin:"elasticsearch"})}),(0,ue.jsx)(l.InlineField,{label:"Alias",labelWidth:15,disabled:!c,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",children:(0,ue.jsx)(l.Input,{id:`ES-query-${n.refId}_alias`,placeholder:"Alias Pattern",onBlur:e=>r(J(e.currentTarget.value)),defaultValue:n.alias})})]}),(0,ue.jsx)(Ft,{nextId:o}),g&&(0,ue.jsx)(it,{nextId:o})]})};var It=i("./public/app/core/config.ts"),Ot=i("./.yarn/__virtual__/react-use-virtual-00326e70ba/3/opt/drone/yarncache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/usePrevious.js"),qt=i("./packages/grafana-runtime/src/index.ts");const{FormField:Mt,Switch:At}=l.LegacyForms,Nt=(0,l.stylesFactory)((()=>({firstRow:n.css`
    display: flex;
  `,nameField:n.css`
    flex: 2;
  `,regexField:n.css`
    flex: 3;
  `,row:n.css`
    display: flex;
    align-items: baseline;
  `,urlField:n.css`
    flex: 1;
  `,urlDisplayLabelField:n.css`
    flex: 1;
  `}))),Ct=e=>{const{value:t,onChange:i,onDelete:s,suggestions:n,className:r}=e,o=Nt(),[d,u]=function(e){const[t,i]=(0,a.useState)(!!e),s=(0,Ot.Z)(e);return(0,a.useEffect)((()=>{s||!e||t||i(!0),s&&!e&&t&&i(!1)}),[s,e,t]),[t,i]}(t.datasourceUid),c=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,ue.jsxs)("div",{className:r,children:[(0,ue.jsxs)("div",{className:o.firstRow+" gf-form",children:[(0,ue.jsx)(Mt,{className:o.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:t.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:c("field")}),(0,ue.jsx)(l.Button,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),s()}})]}),(0,ue.jsxs)("div",{className:"gf-form",children:[(0,ue.jsx)(Mt,{label:d?"Query":"URL",labelWidth:6,inputEl:(0,ue.jsx)(l.DataLinkInput,{placeholder:d?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>i(Object.assign({},t,{url:e})),suggestions:n}),className:o.urlField}),(0,ue.jsx)(Mt,{className:o.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:c("urlDisplayLabel"),tooltip:"Use to override the button label."})]}),(0,ue.jsxs)("div",{className:o.row,children:[(0,ue.jsx)(At,{labelClass:"width-6",label:"Internal link",checked:d,onChange:()=>{d&&i(Object.assign({},t,{datasourceUid:void 0})),u(!d)}}),d&&(0,ue.jsx)(qt.DataSourcePicker,{tracing:!0,onChange:e=>{i(Object.assign({},t,{datasourceUid:e.uid}))},current:t.datasourceUid})]})]})};var Pt;const Vt=e=>({infoText:n.css`
      padding-bottom: ${e.spacing(2)};
      color: ${e.colors.text.secondary};
    `,dataLink:n.css`
      margin-bottom: ${e.spacing(1)};
    `}),Dt=e=>{const{value:t,onChange:i}=e,a=(0,l.useStyles2)(Vt);return(0,ue.jsxs)(ue.Fragment,{children:[Pt||(Pt=(0,ue.jsx)("h3",{className:"page-heading",children:"Data links"})),(0,ue.jsx)("div",{className:a.infoText,children:"Add links to existing fields. Links will be shown in log row details next to the field value."}),t&&t.length>0&&(0,ue.jsx)("div",{className:"gf-form-group",children:t.map(((e,n)=>(0,ue.jsx)(Ct,{className:a.dataLink,value:e,onChange:e=>{const s=[...t];s.splice(n,1,e),i(s)},onDelete:()=>{const e=[...t];e.splice(n,1),i(e)},suggestions:[{value:s.DataLinkBuiltInVars.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:s.VariableOrigin.Value}]},n)))}),(0,ue.jsx)(l.Button,{type:"button",variant:"secondary",className:n.css`
          margin-right: 10px;
        `,icon:"plus",onClick:e=>{e.preventDefault();const s=[...t||[],{field:"",url:""}];i(s)},children:"Add"})]})},$t=e=>{var t;const i=L(e.jsonData.esVersion);return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{timeField:e.jsonData.timeField||"@timestamp",esVersion:i,maxConcurrentShardRequests:e.jsonData.maxConcurrentShardRequests||Ut(i),logMessageField:e.jsonData.logMessageField||"",logLevelField:e.jsonData.logLevelField||"",includeFrozen:null!==(t=e.jsonData.includeFrozen)&&void 0!==t&&t})})},Tt=e=>Boolean(e);var Lt;const Bt=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],Rt=[{label:"2.x",value:"2.0.0"},{label:"5.x",value:"5.0.0"},{label:"5.6+",value:"5.6.0"},{label:"6.0+",value:"6.0.0"},{label:"7.0+",value:"7.0.0"},{label:"7.7+",value:"7.7.0"},{label:"7.10+",value:"7.10.0"},{label:"8.0+",value:"8.0.0",description:"support for Elasticsearch 8 is currently experimental"}],zt=e=>{var t;let{value:i,onChange:s}=e;const n=Rt.find((e=>e.value===i.jsonData.esVersion)),a=!n&&(0,P.valid)(i.jsonData.esVersion)?{label:i.jsonData.esVersion,value:i.jsonData.esVersion}:void 0;return(0,ue.jsx)(ue.Fragment,{children:(0,ue.jsxs)(l.FieldSet,{label:"Elasticsearch details",children:[(0,ue.jsx)(l.InlineField,{label:"Index name",labelWidth:26,children:(0,ue.jsx)(l.Input,{id:"es_config_indexName",value:i.database||"",onChange:Et("database",i,s),width:24,placeholder:"es-index-name",required:!0})}),(0,ue.jsx)(l.InlineField,{label:"Pattern",labelWidth:26,children:(0,ue.jsx)(l.Select,{inputId:"es_config_indexPattern",value:Bt.find((e=>e.value===(void 0===i.jsonData.interval?"none":i.jsonData.interval))),options:Bt,onChange:Qt(i,s),width:24,menuShouldPortal:!0})}),(0,ue.jsx)(l.InlineField,{label:"Time field name",labelWidth:26,children:(0,ue.jsx)(l.Input,{id:"es_config_timeField",value:i.jsonData.timeField||"",onChange:Wt("timeField",i,s),width:24,placeholder:"@timestamp",required:!0})}),(0,ue.jsx)(l.InlineField,{label:"ElasticSearch version",labelWidth:26,children:(0,ue.jsx)(l.Select,{inputId:"es_config_version",options:[a,...Rt].filter(Tt),onChange:e=>{const t=function(e,t){if(5===e&&(0,P.lt)(t,"7.0.0"))return 256;if(256===e&&(0,P.gte)(t,"7.0.0"))return 5;return e||Ut(t)}(i.jsonData.maxConcurrentShardRequests,e.value);s(Object.assign({},i,{jsonData:Object.assign({},i.jsonData,{esVersion:e.value,maxConcurrentShardRequests:t})}))},value:n||a,width:24,menuShouldPortal:!0})}),(0,P.gte)(i.jsonData.esVersion,"5.6.0")&&(0,ue.jsx)(l.InlineField,{label:"Max concurrent Shard Requests",labelWidth:26,children:(0,ue.jsx)(l.Input,{id:"es_config_shardRequests",value:i.jsonData.maxConcurrentShardRequests||"",onChange:Wt("maxConcurrentShardRequests",i,s),width:24})}),(0,ue.jsx)(l.InlineField,{label:"Min time interval",labelWidth:26,tooltip:(0,ue.jsxs)(ue.Fragment,{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",Lt||(Lt=(0,ue.jsx)("code",{children:"1m"}))," if your data is written every minute."]}),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!i.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(i.jsonData.timeInterval),children:(0,ue.jsx)(l.Input,{id:"es_config_minTimeInterval",value:i.jsonData.timeInterval||"",onChange:Wt("timeInterval",i,s),width:24,placeholder:"10s"})}),(0,ue.jsx)(l.InlineField,{label:"X-Pack enabled",labelWidth:26,children:(0,ue.jsx)(l.InlineSwitch,{id:"es_config_xpackEnabled",checked:i.jsonData.xpack||!1,onChange:Ht("xpack",i,s)})}),(0,P.gte)(i.jsonData.esVersion,"6.6.0")&&i.jsonData.xpack&&(0,ue.jsx)(l.InlineField,{label:"Include Frozen Indices",labelWidth:26,children:(0,ue.jsx)(l.InlineSwitch,{id:"es_config_frozenIndices",checked:null!==(t=i.jsonData.includeFrozen)&&void 0!==t&&t,onChange:Ht("includeFrozen",i,s)})})]})})},Et=(e,t,i)=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))},Wt=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.value})}))},Ht=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.checked})}))},Qt=(e,t)=>i=>{const{database:s}=e,n="none"===i.value?void 0:i.value;if(!s||0===s.length||s.startsWith("[logstash-]")){let i="";if(void 0!==n){const e=Bt.find((e=>e.value===n));var a;if(e)i=null!==(a=e.example)&&void 0!==a?a:""}t(Object.assign({},e,{database:i,jsonData:Object.assign({},e.jsonData,{interval:n})}))}else t(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{interval:n})}))};function Ut(e){return(0,P.gte)(e,"7.0.0")?5:256}const Yt=e=>{const{value:t,onChange:i}=e,s=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,ue.jsxs)(l.FieldSet,{label:"Logs",children:[(0,ue.jsx)(l.InlineField,{label:"Message field name",labelWidth:22,children:(0,ue.jsx)(l.Input,{id:"es_logs-config_logMessageField",value:t.logMessageField,onChange:s("logMessageField"),placeholder:"_source",width:24})}),(0,ue.jsx)(l.InlineField,{label:"Level field name",labelWidth:22,children:(0,ue.jsx)(l.Input,{id:"es_logs-config_logLevelField",value:t.logLevelField,onChange:s("logLevelField"),width:24})})]})};var Gt,Zt;var Jt=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),Kt=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/generate.js"),Xt=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),ei=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),ti=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),ii=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),si=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/skipWhile.js"),ni=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/throwIfEmpty.js"),ai=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/first.js"),li=i("./public/app/core/logs_model.ts"),ri=i("./public/app/features/templating/template_srv.ts"),oi=i("./public/app/core/table_model.ts"),di=i("./public/app/core/utils/flatten.ts");const ui=`${O}([^@]+)${q}`;class ci{constructor(e,t){var i,s,n;n=()=>{const e=[];for(let t=0;t<this.response.responses.length;t++){const i=this.response.responses[t],s=this.targets[t];if(i.error)throw this.getErrorFromElasticResponse(this.response,i.error);if(i.hits&&i.hits.hits.length>0&&this.processHits(i.hits,e,s),i.aggregations){const s=i.aggregations,n=this.targets[t],a=[],l=new oi.Z;l.refId=n.refId,this.processBuckets(s,n,a,l,{},0),this.trimDatapoints(a,n),this.nameSeries(a,n);for(let t=0;t<a.length;t++)e.push(a[t]);l.rows.length>0&&e.push(l)}}return{data:e}},(s="processResponseToSeries")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.targets=e,this.response=t,this.targets=e,this.response=t,this.targets=e,this.response=t}processMetrics(e,t,i,s){let n;for(let o=0;o<t.metrics.length;o++){const d=t.metrics[o];if(!d.hide)switch(d.type){case"count":n={datapoints:[],metric:"count",props:s,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i.doc_count;n.datapoints.push([s,i.key])}i.push(n);break;case"percentiles":{if(0===e.buckets.length)break;const a=e.buckets[0][d.id].values;for(const l in a){n={datapoints:[],metric:"p"+l,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].values;n.datapoints.push([s[l],i.key])}i.push(n)}break}case"extended_stats":for(const a in d.meta)if(d.meta[a]){n={datapoints:[],metric:a,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];s.std_deviation_bounds_upper=s.std_deviation_bounds.upper,s.std_deviation_bounds_lower=s.std_deviation_bounds.lower,n.datapoints.push([s[a],i.key])}i.push(n)}break;case"top_metrics":var a,l;if(null!==(a=d.settings)&&void 0!==a&&null!==(l=a.metrics)&&void 0!==l&&l.length)for(const a of null===(r=d.settings)||void 0===r?void 0:r.metrics){var r;n={datapoints:[],metric:d.type,props:s,refId:t.refId,field:a};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].top.map((e=>e.metrics[a]?e.metrics[a]:null)),l=[s[s.length-1],i.key];n.datapoints.push(l)}i.push(n)}break;default:n={datapoints:[],metric:d.type,metricId:d.id,props:s,refId:t.refId},v(d)&&(n.field=d.field);for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];void 0!==s&&(s.normalized_value?n.datapoints.push([s.normalized_value,i.key]):n.datapoints.push([s.value,i.key]))}i.push(n)}}}processAggregationDocs(e,t,i,s,n){if(0===s.columns.length){for(const e of(0,ke.keys)(n))s.addColumn({text:e,filterable:!0});s.addColumn({text:t.field,filterable:!0})}const a=(e,t,i)=>{s.addColumn({text:t}),e.push(i)},l=(0,ke.isArray)(e.buckets)?e.buckets:[e.buckets];for(const e of l){const t=[];for(const e of(0,ke.values)(n))t.push(e);t.push(e.key);for(const s of i.metrics||[])switch(s.type){case"count":a(t,this.getMetricName(s.type),e.doc_count);break;case"extended_stats":for(const i in s.meta){if(!s.meta[i])continue;const n=e[s.id];n.std_deviation_bounds_upper=n.std_deviation_bounds.upper,n.std_deviation_bounds_lower=n.std_deviation_bounds.lower,a(t,this.getMetricName(i),n[i])}break;case"percentiles":{const i=e[s.id].values;for(const e in i)a(t,`p${e} ${s.field}`,i[e]);break}case"top_metrics":{var r;const i=this.getMetricName(s.type);if(null!==(r=s.settings)&&void 0!==r&&r.metrics)for(const n of s.settings.metrics){a(t,s.settings.metrics.length>1?`${i} ${n}`:i,e[s.id].top[0].metrics[n])}break}default:{let n=this.getMetricName(s.type);(0,ke.filter)(i.metrics,{type:s.type}).length>1&&(v(s)&&(n+=" "+s.field),"bucket_script"===s.type&&(n=T(s))),a(t,n,e[s.id].value);break}}s.rows.push(t)}}processBuckets(e,t,i,s,n,a){let l,r,o,d;const u=t.bucketAggs.length-1;for(d in e)if(r=(0,ke.find)(t.bucketAggs,{id:d}),o=e[d],r)if(a===u)"date_histogram"===r.type?this.processMetrics(o,t,i,n):this.processAggregationDocs(o,r,t,s,n);else for(const e in o.buckets)l=o.buckets[e],n=(0,ke.clone)(n),void 0!==l.key?n[r.field]=l.key:n.filter=e,l.key_as_string&&(n[r.field]=l.key_as_string),this.processBuckets(l,t,i,s,n,a+1)}getMetricName(e){const t=Object.entries(F).filter((t=>{let[i]=t;return i===e})).map((e=>{let[t,i]=e;return i}))[0];if(t)return t.label;const i=S.find((t=>t.value===e));return i?i.label:e}getSeriesName(e,t,i){let s=this.getMetricName(e.metric);if(t.alias){const i=/\{\{([\s\S]+?)\}\}/g;return t.alias.replace(i,((t,i,n)=>{const a=i||n;return 0===a.indexOf("term ")?e.props[a.substring(5)]:void 0!==e.props[a]?e.props[a]:"metric"===a?s:"field"===a?e.field||"":t}))}if(e.metric in k)if(e.metric&&function(e){return!!F[e].supportsMultipleBucketPaths}(e.metric)){const i=(0,ke.find)(t.metrics,{id:e.metricId});if(i&&i.settings.script){s=T(i);for(const e of i.pipelineVariables){const i=(0,ke.find)(t.metrics,{id:e.pipelineAgg});i&&(s=s.replace("params."+e.name,V(i)))}}else s="Unset"}else{const i=(0,ke.find)(t.metrics,{id:e.field});i?s+=" "+V(i):s="Unset"}else e.field&&(s+=" "+e.field);if(0===(0,ke.keys)(e.props).length)return s;let n="";for(const t in e.props)n+=e.props[t]+" ";return i?n.trim()+" "+s:n.trim()}nameSeries(e,t){var i;const s=(0,ke.uniq)((0,ke.map)(e,"metric")).length,n=(null===(i=t.metrics)||void 0===i?void 0:i.filter((e=>"top_metrics"===e.type))).some((e=>{var t,i;return((null==e||null===(t=e.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.length)||0)>1}));for(let i=0;i<e.length;i++){const a=e[i];a.target=this.getSeriesName(a,t,s>1||n)}}processHits(e,t,i){const s="number"==typeof e.total?e.total:e.total.value,n={target:i.refId,type:"docs",refId:i.refId,datapoints:[],total:s,filterable:!0};let a,l,r,o;for(o=0;o<e.hits.length;o++){if(l=e.hits[o],r={_id:l._id,_type:l._type,_index:l._index,sort:l.sort,highlight:l.highlight},l._source)for(a in l._source)r[a]=l._source[a];for(a in l.fields)r[a]=l.fields[a];n.datapoints.push(r)}t.push(n)}trimDatapoints(e,t){const i=(0,ke.find)(t.bucketAggs,{type:"date_histogram"});if(i&&i.settings&&i.settings.trimEdges){const t=i.settings.trimEdges;for(const i in e){const s=e[i];s.datapoints.length>2*t&&(s.datapoints=s.datapoints.slice(t,s.datapoints.length-t))}}}getErrorFromElasticResponse(e,t){const i={};return i.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?i.message=t.root_cause[0].reason:i.message=t.reason||"Unknown elastic error response",e.$$config&&(i.config=e.$$config),i}getTimeSeries(){return this.targets.some((e=>C(e,"raw_data")))?this.processResponseToDataFrames(!1):this.processResponseToSeries()}getLogs(e,t){return this.processResponseToDataFrames(!0,e,t)}processResponseToDataFrames(e,t,i){const n=[];for(let l=0;l<this.response.responses.length;l++){const r=this.response.responses[l];if(r.error)throw this.getErrorFromElasticResponse(this.response,r.error);if(r.hits){const{propNames:s,docs:o}=gi(r.hits.hits),d=o.length?pi(s.map(hi(o)),e,this.targets[0].timeField,t,i):pi([],e);e&&mi(d,"logs");for(const e of o){if(i&&(e.level=e[i]),e.highlight){var a;const t=new RegExp(ui,"g"),i=new RegExp(ui),s=Object.keys(e.highlight).flatMap((s=>e.highlight[s].flatMap((e=>{const s=e.match(t);return s?s.map((e=>{const t=e.match(i);return t&&t[1]||null})):[]})))).filter(ke.identity),n=null!==(a=d.meta)&&void 0!==a&&a.searchWords?(0,ke.uniq)([...d.meta.searchWords,...s]):[...s];d.meta=d.meta?Object.assign({},d.meta,{searchWords:n}):{searchWords:n}}d.add(e)}const u=this.targets[l];d.refId=u.refId,n.push(d)}if(r.aggregations){const t=r.aggregations,i=this.targets[l],a=[],o=new oi.Z;if(this.processBuckets(t,i,a,o,{},0),this.trimDatapoints(a,i),this.nameSeries(a,i),o.rows.length>0){const e=(0,s.toDataFrame)(o);e.refId=i.refId,n.push(e)}for(let t=0;t<a.length;t++){let l=(0,s.toDataFrame)(a[t]);e&&mi(l,"graph"),l.refId=i.refId,n.push(l)}}}return{data:n}}}const gi=e=>{const t=[];let i=[];for(const s of e){const e=s._source?(0,di.default)(s._source):{},n=Object.assign({_id:s._id,_type:s._type,_index:s._index,sort:s.sort,highlight:s.highlight,_source:Object.assign({},e)},e);for(const e of Object.keys(n))-1===i.indexOf(e)&&i.push(e);t.push(n)}return i.sort(),{docs:t,propNames:i}},pi=(e,t,i,n,a)=>{const l=new s.MutableDataFrame({fields:[]});if(i&&l.addField({config:{filterable:!0},name:i,type:s.FieldType.time}),n){const e=l.addField({name:n,type:s.FieldType.string});l.setParser(e,(e=>e||""))}if(a){const e=l.addField({name:"level",type:s.FieldType.string});l.setParser(e,(e=>e||""))}const r=l.fields.map((e=>e.name));for(const[i,s]of e){if(r.includes(i))continue;if(!t&&"_source"===i)continue;const e=l.addField({config:{filterable:!0},name:i,type:s});l.setParser(e,(e=>e||""))}return l},mi=(e,t)=>{let i=e;i.meta?i.meta.preferredVisualisationType=t:i.meta={preferredVisualisationType:t}},hi=e=>t=>{var i;return[t,vi(null===(i=e.find((e=>void 0!==e[t])))||void 0===i?void 0:i[t])]},vi=e=>{switch(typeof e){case"number":return s.FieldType.number;case"string":return s.FieldType.string;default:return s.FieldType.other}};const fi={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class bi{constructor(e,t){var i,s,n;n="en",(s="dateLocale")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.pattern=e,this.interval=t,this.pattern=e,this.interval=t}getIndexForToday(){return this.interval?(0,s.toUtc)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,t){if(!this.interval)return this.pattern;const i=fi[this.interval],n=(0,s.dateTime)(e||(0,s.dateTime)(t).add(-7,i.amount)).utc().startOf(i.startOf),a=(0,s.dateTime)(t||(0,s.dateTime)(e).add(7,i.amount)).utc().startOf(i.startOf).valueOf(),l=[];for(;n.valueOf()<=a;)l.push(n.locale(this.dateLocale).format(this.pattern)),n.add(1,i.amount);return l}}class yi extends s.LanguageProvider{constructor(e,t){var i,s,n;super(),n=void 0,(s="datasource")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.datasource=e,Object.assign(this,t)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map((e=>{switch(e.operator){case s.AbstractLabelOperator.Equal:return e.name+':"'+e.value+'"';case s.AbstractLabelOperator.NotEqual:return"NOT "+e.name+':"'+e.value+'"';case s.AbstractLabelOperator.EqualRegEx:return e.name+":/"+e.value+"/";case s.AbstractLabelOperator.NotEqualRegEx:return"NOT "+e.name+":/"+e.value+"/"}})).join(" AND ")}}function xi(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class ji{constructor(e){xi(this,"timeField",void 0),xi(this,"esVersion",void 0),this.timeField=e.timeField,this.esVersion=e.esVersion}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,t,i){var s;if(t.terms={field:e.field},!e.settings)return t;const n=null!==(s=e.settings)&&void 0!==s&&s.size?parseInt(e.settings.size,10):500;if(t.terms.size=0===n?500:n,void 0!==e.settings.orderBy){t.terms.order={},"_term"===e.settings.orderBy&&(0,P.gte)(this.esVersion,"6.0.0")?t.terms.order._key=e.settings.order:t.terms.order[e.settings.orderBy]=e.settings.order;const s=$(e.settings.orderBy);if(s)for(let n of i.metrics||[])if(n.id===s){"count"===n.type?t.terms.order={_count:e.settings.order}:v(n)&&(t.aggs={},t.aggs[n.id]={[n.type]:{field:n.field}});break}}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(t.terms.min_doc_count)&&(t.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(t.terms.missing=e.settings.missing),t}getDateHistogramAgg(e){const t={},i=e.settings||{};t.field=e.field||this.timeField,t.min_doc_count=i.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis",i.timeZone&&i.timeZone!==s.InternalTimeZones.utc&&(t.time_zone=i.timeZone),""!==i.offset&&(t.offset=i.offset);const n="auto"===i.interval?"$__interval":i.interval;return(0,P.gte)(this.esVersion,"8.0.0")?t.fixed_interval=n:t.interval=n,t}getHistogramAgg(e){const t={},i=e.settings||{};return t.interval=i.interval,t.field=e.field,t.min_doc_count=i.min_doc_count||0,t}getFiltersAgg(e){const t={};for(let{query:s,label:n}of(null===(i=e.settings)||void 0===i?void 0:i.filters)||[]){var i;t[n||s]={query_string:{query:s,analyze_wildcard:!0}}}return t}documentQuery(e,t){return e.size=t,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],(0,P.lt)(this.esVersion,"5.0.0")&&(e.fields=["*","_source"]),e.script_fields={},e}addAdhocFilters(e,t){if(!t)return;let i,s,n,a;for(i=0;i<t.length;i++)switch(s=t[i],n={},n[s.key]=s.value,a={},a[s.key]={query:s.value},s.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:a});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:a});break;case"<":n[s.key]={lt:s.value},e.query.bool.filter.push({range:n});break;case">":n[s.key]={gt:s.value},e.query.bool.filter.push({range:n});break;case"=~":e.query.bool.filter.push({regexp:n});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:n}}})}}build(e,t){var i,s,n,a,l,r,o,d,u;let c,g,p,m,y;e.metrics=e.metrics||[M()],e.bucketAggs=e.bucketAggs||[A()],e.timeField=this.timeField;const j={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&""!==e.query&&(j.query.bool.filter=[...j.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),this.addAdhocFilters(j,t),0===e.bucketAggs.length&&(c=e.metrics[0],!c||"raw_document"!==c.type&&"raw_data"!==c.type))throw{message:"Invalid query"};if("raw_document"===(null===(i=e.metrics)||void 0===i||null===(s=i[0])||void 0===s?void 0:s.type)||"raw_data"===(null===(n=e.metrics)||void 0===n||null===(a=n[0])||void 0===a?void 0:a.type)){var _;c=e.metrics[0];const t=null!==(_=c.settings)&&void 0!==_&&_.size?parseInt(c.settings.size,10):500;return this.documentQuery(j,t||500)}for(y=j,g=0;g<e.bucketAggs.length;g++){const t=e.bucketAggs[g],i={};switch(t.type){case"date_histogram":i.date_histogram=this.getDateHistogramAgg(t);break;case"histogram":i.histogram=this.getHistogramAgg(t);break;case"filters":i.filters={filters:this.getFiltersAgg(t)};break;case"terms":this.buildTermsAgg(t,i,e);break;case"geohash_grid":var F;i.geohash_grid={field:t.field,precision:null===(F=t.settings)||void 0===F?void 0:F.precision}}y.aggs=y.aggs||{},y.aggs[t.id]=i,y=i}for(y.aggs={},g=0;g<e.metrics.length;g++){if(c=e.metrics[g],"count"===c.type)continue;const t={};let i={};if(f(c))if(b(c)){if(!c.pipelineVariables)continue;for(i={buckets_path:{}},p=0;p<c.pipelineVariables.length;p++)if(m=c.pipelineVariables[p],m.name&&m.pipelineAgg&&/^\d*$/.test(m.pipelineAgg)){const t=N(e.metrics,m.pipelineAgg);t&&("count"===t.type?i.buckets_path[m.name]="_count":i.buckets_path[m.name]=m.pipelineAgg)}}else{if(!c.field||!/^\d*$/.test(c.field))continue;{const t=N(e.metrics,c.field);t&&(i="count"===t.type?{buckets_path:"_count"}:{buckets_path:c.field})}}else v(c)&&(i={field:c.field});if(x(c))switch(Object.entries(c.settings||{}).filter((e=>{let[t,i]=e;return null!==i})).forEach((e=>{let[t,s]=e;i[t]="script"===t?this.buildScript(T(c)):s})),c.type){case"moving_avg":i=Object.assign({},i,void 0!==(null===(l=i)||void 0===l?void 0:l.window)&&{window:this.toNumber(i.window)},void 0!==(null===(r=i)||void 0===r?void 0:r.predict)&&{predict:this.toNumber(i.predict)},h(c)&&{settings:Object.assign({},i.settings,Object.fromEntries(Object.entries(i.settings||{}).filter((e=>{let[t]=e;return["alpha","beta","gamma","period"].includes(t)})).filter((e=>{let[t,i]=e;return void 0!==i})).map((e=>{let[t,i]=e;return[t,this.toNumber(i)]}))))});break;case"serial_diff":i=Object.assign({},i,void 0!==i.lag&&{lag:this.toNumber(i.lag)});break;case"top_metrics":var k,w;if(i={metrics:null===(o=c.settings)||void 0===o||null===(d=o.metrics)||void 0===d?void 0:d.map((e=>({field:e}))),size:1},null!==(u=c.settings)&&void 0!==u&&u.orderBy)i.sort=[{[null===(k=c.settings)||void 0===k?void 0:k.orderBy]:null===(w=c.settings)||void 0===w?void 0:w.order}]}t[c.type]=i,y.aggs[c.id]=t}return j}buildScript(e){return(0,P.gte)(this.esVersion,"5.6.0")?e:{inline:e}}toNumber(e){const t=parseFloat(`${e}`);return isNaN(t)?e:t}getTermsQuery(e){const t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let i=500;e.size&&(i=e.size),t.aggs={1:{terms:{field:e.field,size:i,order:{}}}};const{orderBy:s="key",order:n=("doc_count"===s?"desc":"asc")}=e;if(["asc","desc"].indexOf(n)<0)throw{message:`Invalid query sort order ${n}`};switch(s){case"key":case"term":const e=(0,P.gte)(this.esVersion,"6.0.0")?"_key":"_term";t.aggs[1].terms.order[e]=n;break;case"doc_count":t.aggs[1].terms.order._count=n;break;default:throw{message:`Invalid query sort type ${s}`}}return t}getLogsQuery(e,t,i){let s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return this.addAdhocFilters(s,i),e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),s=this.documentQuery(s,t),Object.assign({},s,{aggs:this.build(e,null).aggs,highlight:{fields:{"*":{}},pre_tags:[O],post_tags:[q],fragment_size:2147483647}})}}function _i(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const Fi=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class ki extends s.DataSourceApi{constructor(e){var t,i;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,ri.J)();super(e),_i(this,"basicAuth",void 0),_i(this,"withCredentials",void 0),_i(this,"url",void 0),_i(this,"name",void 0),_i(this,"index",void 0),_i(this,"timeField",void 0),_i(this,"esVersion",void 0),_i(this,"xpack",void 0),_i(this,"interval",void 0),_i(this,"maxConcurrentShardRequests",void 0),_i(this,"queryBuilder",void 0),_i(this,"indexPattern",void 0),_i(this,"logMessageField",void 0),_i(this,"logLevelField",void 0),_i(this,"dataLinks",void 0),_i(this,"languageProvider",void 0),_i(this,"includeFrozen",void 0),_i(this,"getLogRowContext",(async(e,t)=>{var i;const n=e.dataFrame.fields.find((e=>"sort"===e.name)),a=(null==n?void 0:n.values.get(e.rowIndex))||[e.timeEpochMs],l="FORWARD"===(null==t?void 0:t.direction)?"asc":"desc",r="FORWARD"===(null==t?void 0:t.direction)?this.getQueryHeader("query_then_fetch",(0,s.dateTime)(e.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,s.dateTime)(e.timeEpochMs)),o=null!==(i=null==t?void 0:t.limit)&&void 0!==i?i:10,d=[r,JSON.stringify({size:o,query:{bool:{filter:[{range:{[this.timeField]:{["FORWARD"===(null==t?void 0:t.direction)?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:l},{_doc:l}],search_after:a})].join("\n")+"\n",u=this.getMultiSearchUrl(),c=await(0,Ie.n)(this.post(u,d)),g=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],p=new ci(g,function(e,t){if("desc"===t)return e;const i=e.responses[0];return Object.assign({},e,{responses:[Object.assign({},i,{hits:Object.assign({},i.hits,{hits:i.hits.hits.reverse()})})]})}(c,l)),m=p.getLogs(this.logMessageField,this.logLevelField),h=(0,ke.first)(m.data);if(!h)return{data:[]};const v=h.fields.find((e=>e.name===this.timeField)),f=h.fields.find((e=>e.name===this.logMessageField));return v&&f?{data:[Object.assign({},h,{fields:[...h.fields,Object.assign({},v,{name:"ts"}),Object.assign({},f,{name:"line"})]})]}:m})),this.templateSrv=n,this.templateSrv=n,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=null!==(t=e.database)&&void 0!==t?t:"";const a=e.jsonData||{};this.timeField=a.timeField,this.esVersion=L(a.esVersion),this.xpack=Boolean(a.xpack),this.indexPattern=new bi(this.index,a.interval),this.interval=a.timeInterval,this.maxConcurrentShardRequests=a.maxConcurrentShardRequests,this.queryBuilder=new ji({timeField:this.timeField,esVersion:this.esVersion}),this.logMessageField=a.logMessageField||"",this.logLevelField=a.logLevelField||"",this.dataLinks=a.dataLinks||[],this.includeFrozen=null!==(i=a.includeFrozen)&&void 0!==i&&i,""===this.logMessageField&&(this.logMessageField=void 0),""===this.logLevelField&&(this.logLevelField=void 0),this.languageProvider=new yi(this)}request(e,t,i,s){const n={url:this.url+"/"+t,method:e,data:i,headers:s};return(this.basicAuth||this.withCredentials)&&(n.withCredentials=!0),this.basicAuth&&(n.headers={Authorization:this.basicAuth}),(0,qt.getBackendSrv)().fetch(n).pipe((0,ei.U)((e=>(e.data.$$config=e.config,e.data))),(0,ti.K)((e=>{if(e.data){var t,i,s;const n=null!==(t=null!==(i=null===(s=e.data.error)||void 0===s?void 0:s.reason)&&void 0!==i?i:e.data.message)&&void 0!==t?t:"Unknown error";return(0,Jt._)({message:"Elasticsearch error: "+n,error:e.data.error})}return(0,Jt._)(e)})))}async importFromAbstractQueries(e){return e.map((e=>this.languageProvider.importFromAbstractQuery(e)))}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,s.getDefaultTimeRange)(),i=this.indexPattern.getIndexList(t.from,t.to);Array.isArray(i)||(i=[this.indexPattern.getIndexForToday()]);const n=i.map((t=>t+e));return this.requestAllIndices(n)}requestAllIndices(e){const t=e.length;return(0,Kt.R)({initialState:0,condition:e=>e<Math.min(t,7),iterate:e=>e+1}).pipe((0,ii.z)((i=>this.request("GET",e[t-i-1]).pipe((0,ti.K)((e=>(0,Xt.of)({err:e})))))),(0,si.n)((e=>{var t;return 404===(null==e||null===(t=e.err)||void 0===t?void 0:t.status)})),(0,ni.T)((()=>"Could not find an available index for this time range.")),(0,ai.P)(),(0,ei.U)((e=>{if(e.err)throw e.err;return e})))}post(e,t){return this.request("POST",e,t,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const t=e.annotation,i=t.timeField||"@timestamp",n=t.timeEndField||null,a=t.query,l=t.tagsField||"tags",r=t.textField||null,o=[],d={};if(d[i]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},o.push({range:d}),n){const t={};t[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},o.push({range:t})}const u=this.interpolateLuceneQuery(a),c={bool:{filter:[{bool:{should:o,minimum_should_match:1}}]}};u&&c.bool.filter.push({query_string:{query:u}});const g={query:c,size:1e4};(0,P.lt)(this.esVersion,"5.0.0")&&(g.fields=[i,"_source"]);const p={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?p.index=t.index:p.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const m=JSON.stringify(p)+"\n"+JSON.stringify(g)+"\n";return(0,Ie.n)(this.post("_msearch",m).pipe((0,ei.U)((e=>{const a=[],o=e.responses[0].hits.hits,d=(e,t)=>{if(!t)return;const i=t.split(".");let s=e;for(let e=0;e<i.length;e++)if(s=s[i[e]],!s)return console.log("could not find field in annotation: ",t),"";return s};for(let e=0;e<o.length;e++){const u=o[e]._source;let c=d(u,i);if(void 0!==o[e].fields){const t=o[e].fields;((0,ke.isString)(t[i])||(0,ke.isNumber)(t[i]))&&(c=t[i])}const g={annotation:t,time:(0,s.toUtc)(c).valueOf(),text:d(u,r),tags:d(u,l)};if(n){const e=d(u,n);e&&(g.timeEnd=(0,s.toUtc)(e).valueOf())}if(t.titleField){const e=d(u,t.titleField);e&&(g.text=e+"\n"+g.text)}"string"==typeof g.tags&&(g.tags=g.tags.split(",")),a.push(g)}return a}))))}interpolateLuceneQuery(e,t){return this.templateSrv.replace(e,t,"lucene")}interpolateVariablesInQueries(e,t){const i=e=>{var i,s;return"filters"===e.type?Object.assign({},e,{settings:Object.assign({},e.settings,{filters:null===(i=e.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.map((e=>Object.assign({},e,{query:this.interpolateLuceneQuery(e.query,t)||"*"})))})}):e},s=e.map((e=>{var s;return Object.assign({},e,{datasource:this.getRef(),query:this.interpolateLuceneQuery(e.query||"",t),bucketAggs:null===(s=e.bucketAggs)||void 0===s?void 0:s.map(i)})}));return JSON.parse(this.templateSrv.replace(JSON.stringify(s),t))}testDatasource(){return(0,Ie.n)(this.getFields(["date"]).pipe((0,ii.z)((e=>(0,ke.find)(e,{text:this.timeField})?(0,Xt.of)({status:"success",message:"Index OK. Time field name OK."}):(0,Xt.of)({status:"error",message:"No date field named "+this.timeField+" found"}))),(0,ti.K)((e=>(console.error(e),e.message?(0,Xt.of)({status:"error",message:e.message}):(0,Xt.of)({status:"error",message:e.status}))))))}getQueryHeader(e,t,i){const s={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,i)};return(0,P.satisfies)(this.esVersion,">=5.6.0 <7.0.0")&&(s.max_concurrent_shard_requests=this.maxConcurrentShardRequests),JSON.stringify(s)}getQueryDisplayText(e){const t=e.metrics,i=e.bucketAggs;let s="";return e.query&&(s+="Query: "+e.query+", "),s+="Metrics: ",s+=null==t?void 0:t.reduce(((e,t)=>{let i=F[t.type].label+"(";return v(t)&&(i+=t.field),b(t)&&(i+=T(t).replace(new RegExp("params.","g"),"")),i+="), ",`${e} ${i}`}),""),s+=null==i?void 0:i.reduce(((e,t,i)=>{let s="";return 0===i&&(s+=" Group by: "),s+=ee[t.type].label+"(",Oe(t)&&(s+=t.field),`${e} ${s}), `}),""),e.alias&&(s+="Alias: "+e.alias),s}showContextToggle(){return(0,P.gte)(this.esVersion,"5.0.0")}getLogsVolumeDataProvider(e){if(!e.targets.some((e=>{var t;return 1===(null===(t=e.metrics)||void 0===t?void 0:t.length)&&"logs"===e.metrics[0].type})))return;const t=(0,ke.cloneDeep)(e);return t.targets=t.targets.map((e=>{var t;const i=[],n=null!==(t=this.timeField)&&void 0!==t?t:"@timestamp";this.logLevelField&&i.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:s.LogLevel.unknown},field:this.logLevelField}),i.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:n});return{refId:e.refId,query:e.query,metrics:[{type:"count",id:"1"}],timeField:n,bucketAggs:i}})),(0,li.Bz)(this,t,{range:e.range,targets:e.targets,extractLevel:e=>(0,s.getLogLevelFromKey)(e.name||"")})}query(e){let t="";const i=this.interpolateVariablesInQueries((0,ke.cloneDeep)(e.targets),e.scopedVars),s=[];let n=i.some((e=>C(e,"logs")));const a=this.templateSrv.getAdhocFilters(this.name),l=[];for(const n of i){if(n.hide)continue;let i;if(C(n,"logs")){var r,o,d;n.bucketAggs=[A()];const e=null===(r=n.metrics)||void 0===r?void 0:r.find((e=>"logs"===e.type)),t=null!==(o=e.settings)&&void 0!==o&&o.limit?parseInt(null===(d=e.settings)||void 0===d?void 0:d.limit,10):500;l.push(t),n.metrics=[],i=this.queryBuilder.getLogsQuery(n,t,a)}else l.push(),n.alias&&(n.alias=this.interpolateLuceneQuery(n.alias,e.scopedVars)),i=this.queryBuilder.build(n,a);const u=JSON.stringify(i),c=0===i.size&&(0,P.lt)(this.esVersion,"5.0.0")?"count":"query_then_fetch";t+=this.getQueryHeader(c,e.range.from,e.range.to)+"\n",t+=u+"\n",s.push(n)}if(0===s.length)return(0,Xt.of)({data:[]});t=t.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),t=t.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),t=this.templateSrv.replace(t,e.scopedVars);const u=this.getMultiSearchUrl();return this.post(u,t).pipe((0,ei.U)((e=>{const t=new ci(s,e);if(n){const e=t.getLogs(this.logMessageField,this.logLevelField);return e.data.forEach(((e,t)=>{!function(e,t,i){i&&(e.meta=Object.assign({},e.meta,{limit:i}));if(!t.length)return;for(const i of e.fields){const e=t.filter((e=>new RegExp(e.field).test(i.name)));0!==e.length&&(i.config=i.config||{},i.config.links=[...(i.config.links,e.map(wi))])}}(e,this.dataLinks,l[t])})),e}return t.getTimeSeries()})))}isMetadataField(e){return Fi.includes(e)}getFields(e,t){const i={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",t).pipe((0,ei.U)((t=>{const s=(t,s)=>!this.isMetadataField(s)&&(!e||0===e.length||(e.includes(t.type)||e.includes(i[t.type]))),n=[],a={};function l(e){for(const t in e){const i=e[t];if((0,ke.isObject)(i.properties)&&(n.push(t),l(i.properties)),(0,ke.isObject)(i.fields)&&(n.push(t),l(i.fields)),(0,ke.isString)(i.type)){const e=n.concat(t).join(".");s(i,t)&&(a[e]={text:e,type:i.type})}}n.pop()}for(const e in t){const i=t[e];if(i&&i.mappings){const e=i.mappings;if((0,P.lt)(this.esVersion,"7.0.0"))for(const t in e){l(e[t].properties)}else{l(e.properties)}}}return(0,ke.map)(a,(e=>e))})))}getTerms(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,s.getDefaultTimeRange)();const i=(0,P.gte)(this.esVersion,"5.0.0")?"query_then_fetch":"count",n=this.getQueryHeader(i,t.from,t.to);let a=JSON.stringify(this.queryBuilder.getTermsQuery(e));a=a.replace(/\$timeFrom/g,t.from.valueOf().toString()),a=a.replace(/\$timeTo/g,t.to.valueOf().toString()),a=n+"\n"+a+"\n";const l=this.getMultiSearchUrl();return this.post(l,a).pipe((0,ei.U)((e=>{if(!e.responses[0].aggregations)return[];const t=e.responses[0].aggregations[1].buckets;return(0,ke.map)(t,(e=>({text:e.key_as_string||e.key,value:e.key})))})))}getMultiSearchUrl(){const e=new URLSearchParams;return(0,P.gte)(this.esVersion,"7.0.0")&&this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),(0,P.gte)(this.esVersion,"6.6.0")&&this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,t){const i=null==t?void 0:t.range,s=JSON.parse(e);if(e){if("fields"===s.find)return s.type=this.interpolateLuceneQuery(s.type),(0,Ie.n)(this.getFields(s.type,i));if("terms"===s.find)return s.field=this.interpolateLuceneQuery(s.field),s.query=this.interpolateLuceneQuery(s.query),(0,Ie.n)(this.getTerms(s,i))}return Promise.resolve([])}getTagKeys(){return(0,Ie.n)(this.getFields())}getTagValues(e){return(0,Ie.n)(this.getTerms({field:e.key}))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const t of e.bucketAggs)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings))return!0;for(const t of e.metrics)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings)||this.objectContainsTemplate(t.meta))return!0;return!1}isPrimitive(e){return null==e||!!["string","number","boolean"].some((e=>"boolean"===e))}objectContainsTemplate(e){if(!e)return!1;for(const t of Object.keys(e))if(this.isPrimitive(e[t])){if(this.templateSrv.containsTemplate(e[t]))return!0}else if(Array.isArray(e[t])){for(const i of e[t])if(this.objectContainsTemplate(i))return!0}else if(this.objectContainsTemplate(e[t]))return!0;return!1}}function wi(e){const t=(0,qt.getDataSourceSrv)();if(e.datasourceUid){var i;const s=t.getInstanceSettings(e.datasourceUid);return{title:e.urlDisplayLabel||"",url:"",internal:{query:{query:e.url},datasourceUid:e.datasourceUid,datasourceName:null!==(i=null==s?void 0:s.name)&&void 0!==i?i:"Data source not found"}}}return{title:e.urlDisplayLabel||"",url:e.url}}class Si{}var Ii,Oi,qi;qi="partials/annotations.editor.html",(Oi="templateUrl")in(Ii=Si)?Object.defineProperty(Ii,Oi,{value:qi,enumerable:!0,configurable:!0,writable:!0}):Ii[Oi]=qi;const Mi=new s.DataSourcePlugin(ki).setQueryEditor((e=>{let{query:t,onChange:i,onRunQuery:n,datasource:a,range:l}=e;return(0,ue.jsx)(me,{datasource:a,onChange:i,onRunQuery:n,query:t,range:l||(0,s.getDefaultTimeRange)(),children:(0,ue.jsx)(St,{value:t})})})).setConfigEditor((e=>{const{options:t,onOptionsChange:i}=e,s=$t(t);(0,a.useEffect)((()=>{(e=>!!(0,P.valid)(e.jsonData.esVersion)&&!!e.jsonData.timeField&&!!e.jsonData.maxConcurrentShardRequests&&void 0!==e.jsonData.logMessageField&&void 0!==e.jsonData.logLevelField)(t)||i($t(t))}),[]);const n=(r=s.jsonData.esVersion,!(0,P.gte)(r,"7.10.0"));var r;return(0,ue.jsxs)(ue.Fragment,{children:["direct"===s.access&&(Gt||(Gt=(0,ue.jsx)(l.Alert,{title:"Deprecation Notice",severity:"warning",children:"Browser access mode in the Elasticsearch datasource is deprecated and will be removed in a future release."}))),n&&(Zt||(Zt=(0,ue.jsx)(l.Alert,{title:"Deprecation notice",severity:"warning",children:"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) is deprecated and will be removed in a future release."}))),(0,ue.jsx)(l.DataSourceHttpSettings,{defaultUrl:"http://localhost:9200",dataSourceConfig:s,showAccessOptions:!0,onChange:i,sigV4AuthToggleEnabled:It.vc.sigV4AuthEnabled}),(0,ue.jsx)(zt,{value:s,onChange:i}),(0,ue.jsx)(Yt,{value:s.jsonData,onChange:e=>i(Object.assign({},s,{jsonData:e}))}),(0,ue.jsx)(Dt,{value:s.jsonData.dataLinks,onChange:e=>{i(Object.assign({},s,{jsonData:Object.assign({},s.jsonData,{dataLinks:e})}))}})]})})).setAnnotationQueryCtrl(Si)},"./.yarn/__virtual__/react-use-virtual-00326e70ba/3/opt/drone/yarncache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/usePrevious.js":(e,t,i)=>{i.d(t,{Z:()=>n});var s=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js");function n(e){var t=(0,s.useRef)();return(0,s.useEffect)((function(){t.current=e})),t.current}}}]);
//# sourceMappingURL=elasticsearchPlugin.b208037f6b1954dc031d.js.map